<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합 시뮬레이터 - BDS + 재정자립도 통합 정책 효과 분석</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px;
            padding: 30px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        .nav-breadcrumb {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .parameter-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        .policy-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        .slider-container {
            margin: 15px 0;
        }
        .slider-label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        .slider-value {
            color: #667eea;
            font-weight: bold;
        }
        .btn-simulate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        .btn-simulate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .results-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .chart-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        #integrated-map {
            height: 400px;
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        
        .chart-description {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .chart-description h6 {
            margin: 0;
            color: #333;
        }
        
        .region-legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 15px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="nav-breadcrumb">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="index.html"><i class="fas fa-home"></i> 메인</a></li>
                    <li class="breadcrumb-item active" aria-current="page">통합 시뮬레이터</li>
                </ol>
            </nav>
        </div>

        <div class="header">
            <h1><i class="fas fa-link"></i> 통합 시뮬레이터</h1>
            <p>BDS와 재정자립도를 통합한 종합 정책 효과 분석 시스템</p>
        </div>

        <div class="parameter-section">
            <h3><i class="fas fa-sliders-h"></i> 통합 정책 파라미터 설정</h3>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="policy-card">
                        <h5><i class="fas fa-users"></i> 인구 정책</h5>
                        <div class="slider-container">
                            <div class="slider-label">정책 강도: <span class="slider-value" id="population_intensity_value">1.0</span></div>
                            <input type="range" id="population_intensity" min="0.1" max="3.0" step="0.1" value="1.0" class="form-range">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">정책 기간: <span class="slider-value" id="population_duration_value">5년</span></div>
                            <input type="range" id="population_duration" min="1" max="10" step="1" value="5" class="form-range">
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="policy-card">
                        <h5><i class="fas fa-industry"></i> 산업 정책</h5>
                        <div class="slider-container">
                            <div class="slider-label">정책 강도: <span class="slider-value" id="industry_intensity_value">1.0</span></div>
                            <input type="range" id="industry_intensity" min="0.1" max="3.0" step="0.1" value="1.0" class="form-range">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">정책 기간: <span class="slider-value" id="industry_duration_value">5년</span></div>
                            <input type="range" id="industry_duration" min="1" max="10" step="1" value="5" class="form-range">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="policy-card">
                        <h5><i class="fas fa-road"></i> 인프라 정책</h5>
                        <div class="slider-container">
                            <div class="slider-label">정책 강도: <span class="slider-value" id="infrastructure_intensity_value">1.0</span></div>
                            <input type="range" id="infrastructure_intensity" min="0.1" max="3.0" step="0.1" value="1.0" class="form-range">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">정책 기간: <span class="slider-value" id="infrastructure_duration_value">5년</span></div>
                            <input type="range" id="infrastructure_duration" min="1" max="10" step="1" value="5" class="form-range">
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="policy-card">
                        <h5><i class="fas fa-balance-scale"></i> 제도 정책</h5>
                        <div class="slider-container">
                            <div class="slider-label">정책 강도: <span class="slider-value" id="institutional_intensity_value">1.0</span></div>
                            <input type="range" id="institutional_intensity" min="0.1" max="3.0" step="0.1" value="1.0" class="form-range">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">정책 기간: <span class="slider-value" id="institutional_duration_value">5년</span></div>
                            <input type="range" id="institutional_duration" min="1" max="10" step="1" value="5" class="form-range">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <button class="btn-simulate" onclick="runIntegratedSimulation()">
                    <i class="fas fa-play"></i> 통합 시뮬레이션 실행
                </button>
            </div>
        </div>

        <!-- 결과 섹션 -->
        <div class="results-section" id="results-section" style="display: none;">
            <h3><i class="fas fa-chart-bar"></i> 시뮬레이션 결과</h3>
            
            <!-- 지표 카드들 -->
            <div class="row">
                <div class="col-md-3">
                    <div class="metric-card">
                        <div><i class="fas fa-chart-line"></i> BDS 개선 효과</div>
                        <div class="metric-value" id="bds-improvement">0%p</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div><i class="fas fa-dollar-sign"></i> 재정자립도 개선</div>
                        <div class="metric-value" id="fiscal-improvement">0%p</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div><i class="fas fa-percentage"></i> 종합 효율성</div>
                        <div class="metric-value" id="overall-efficiency">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div><i class="fas fa-exclamation-triangle"></i> 총 리스크</div>
                        <div class="metric-value" id="total-risk">0억원</div>
                    </div>
                </div>
            </div>

            <!-- 차트 영역 -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="chart-container">
                        <div class="chart-description">
                            <h6><i class="fas fa-map"></i> 통합 효과 지도</h6>
                            <button class="btn btn-sm btn-outline-info" onclick="showHelpModal('integratedMapModal')">
                                <i class="fas fa-question-circle"></i> 도움말
                            </button>
                        </div>
                        <div id="integrated-map"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <div class="chart-description">
                            <h6><i class="fas fa-dice"></i> 몬테카를로 시뮬레이션 결과</h6>
                            <button class="btn btn-sm btn-outline-info" onclick="showHelpModal('monteCarloModal')">
                                <i class="fas fa-question-circle"></i> 도움말
                            </button>
                        </div>
                        <div id="monte-carlo-chart"></div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="chart-container">
                        <div class="chart-description">
                            <h6><i class="fas fa-chart-pie"></i> 정책별 효과 분석</h6>
                            <button class="btn btn-sm btn-outline-info" onclick="showHelpModal('policyEffectsModal')">
                                <i class="fas fa-question-circle"></i> 도움말
                            </button>
                        </div>
                        <div id="policy-effects-chart"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <div class="chart-description">
                            <h6><i class="fas fa-chart-line"></i> BDS vs 재정자립도 비교</h6>
                            <button class="btn btn-sm btn-outline-info" onclick="showHelpModal('comparisonModal')">
                                <i class="fas fa-question-circle"></i> 도움말
                            </button>
                        </div>
                        <div id="comparison-chart"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 고정된 시드 값
        const FIXED_SEED = 12345;
        
        // 시드 기반 랜덤 함수
        function seededRandom(seed) {
            const x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        // ==========================
        // 실측 데이터 로딩 섹션 (KOSIS / BDS)
        // ==========================
        let fiscalBaselineByRegion = {}; // { region: { autonomy: number, independence: number } }
        let fiscalLatestYear = null;
        let fiscalDataPromise = null;
        let bdsBaselineByRegion = {}; // { region: number }
        let bdsLatestYear = null;
        let bdsDataPromise = null;

        function loadFiscalMeasuredData() {
            if (fiscalDataPromise) return fiscalDataPromise;
            fiscalDataPromise = fetch('data/fiscal_autonomy/kosis_fiscal_autonomy_data.csv')
                .then(resp => {
                    if (!resp.ok) throw new Error('KOSIS CSV 로드 실패');
                    return resp.text();
                })
                .then(text => {
                    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
                    if (lines.length <= 1) throw new Error('CSV 내용이 비어 있습니다');
                    const header = lines[0].replace(/^\uFEFF/, '').split(',');
                    const idxYear = header.indexOf('year');
                    const idxRegion = header.indexOf('region');
                    const idxAuto = header.indexOf('fiscal_autonomy_ratio');
                    const idxInd = header.indexOf('fiscal_independence_ratio');
                    if (idxYear < 0 || idxRegion < 0 || idxAuto < 0 || idxInd < 0) {
                        throw new Error('CSV 헤더를 인식할 수 없습니다');
                    }
                    // 최신 연도 탐색 및 지역별 최신값 캐시
                    let latest = -Infinity;
                    const rows = [];
                    for (let i = 1; i < lines.length; i++) {
                        const cols = lines[i].split(',');
                        if (cols.length < header.length) continue;
                        const y = parseInt(cols[idxYear], 10);
                        const r = cols[idxRegion];
                        const a = parseFloat(cols[idxAuto]);
                        const d = parseFloat(cols[idxInd]);
                        if (!Number.isFinite(y) || !r) continue;
                        latest = Math.max(latest, y);
                        rows.push({ year: y, region: r, autonomy: a, independence: d });
                    }
                    fiscalLatestYear = latest;
                    const latestRows = rows.filter(row => row.year === fiscalLatestYear);
                    fiscalBaselineByRegion = {};
                    latestRows.forEach(row => {
                        fiscalBaselineByRegion[row.region] = { autonomy: row.autonomy, independence: row.independence };
                    });
                    return { latestYear: fiscalLatestYear, baselines: fiscalBaselineByRegion };
                });
            return fiscalDataPromise;
        }

        function loadBdsMeasuredData() {
            if (bdsDataPromise) return bdsDataPromise;
            // NAVIS는 검증용으로 유지하고, 계산은 공식 데이터에서 산출한 BDS를 사용
            bdsDataPromise = fetch('data/bds/bds_baseline.json')
                .then(resp => {
                    if (!resp.ok) throw new Error('BDS JSON 로드 실패');
                    return resp.json();
                })
                .then(json => {
                    bdsLatestYear = json.latestYear;
                    bdsBaselineByRegion = json.baselines || {};
                    return { latestYear: bdsLatestYear, baselines: bdsBaselineByRegion };
                });
            return bdsDataPromise;
        }

        // 슬라이더 이벤트 리스너
        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', function() {
                const valueDisplay = document.getElementById(this.id + '_value');
                if (this.id.includes('duration')) {
                    valueDisplay.textContent = this.value + '년';
                } else {
                    valueDisplay.textContent = parseFloat(this.value).toFixed(1);
                }
            });
        });

        // 통합 시뮬레이션 실행
        async function runIntegratedSimulation() {
            console.log("통합 시뮬레이션 실행");
            
            try {
                // 실측 데이터 로드 대기 (KOSIS, BDS)
                await Promise.all([loadFiscalMeasuredData(), loadBdsMeasuredData()]);
                // 파라미터 수집
                const parameters = collectIntegratedParameters();
                
                console.log("파라미터 수집 완료:", parameters);
                
                // 시뮬레이션 실행
                const results = simulateIntegrated(parameters);
                
                console.log("시뮬레이션 결과:", results);
                
                // 결과 표시
                displayIntegratedSimulationResults(results);
                
                document.getElementById('results-section').style.display = 'block';
                
                console.log("통합 시뮬레이션 완료");
            } catch (error) {
                console.error("통합 시뮬레이션 오류:", error);
                alert("시뮬레이션 실행 중 오류가 발생했습니다: " + error.message);
            }
        }

        // 파라미터 수집 함수
        function collectIntegratedParameters() {
            return {
                population: {
                    intensity: parseFloat(document.getElementById('population_intensity').value),
                    duration: parseInt(document.getElementById('population_duration').value)
                },
                industry: {
                    intensity: parseFloat(document.getElementById('industry_intensity').value),
                    duration: parseInt(document.getElementById('industry_duration').value)
                },
                infrastructure: {
                    intensity: parseFloat(document.getElementById('infrastructure_intensity').value),
                    duration: parseInt(document.getElementById('infrastructure_duration').value)
                },
                institutional: {
                    intensity: parseFloat(document.getElementById('institutional_intensity').value),
                    duration: parseInt(document.getElementById('institutional_duration').value)
                }
            };
        }

        // 통합 시뮬레이션 함수
        function simulateIntegrated(parameters) {
            // BDS 시뮬레이션
            const bdsResults = simulateBDS(parameters);
            
            // 재정자립도 시뮬레이션
            const fiscalResults = simulateFiscal(parameters);
            
            // 통합 결과 계산
            const overallEfficiency = (bdsResults.bdsImprovement + fiscalResults.fiscalImprovement) / 
                                    (bdsResults.totalCost + fiscalResults.totalCost);
            const totalRisk = bdsResults.totalRisk + fiscalResults.totalRisk;
            
            return {
                bds: bdsResults,
                fiscal: fiscalResults,
                overallEfficiency: overallEfficiency,
                totalRisk: totalRisk
            };
        }

        // BDS 시뮬레이션 함수
        function simulateBDS(parameters) {
            const results = {
                bdsImprovement: 0,
                regionalEffects: {},
                totalCost: 0,
                totalRisk: 0
            };
            
            let totalImprovement = 0;
            let totalCost = 0;
            let totalRisk = 0;
            
            const regions = ['서울특별시', '부산광역시', '대구광역시', '인천광역시', '광주광역시', 
                           '대전광역시', '울산광역시', '세종특별자치시', '경기도', '강원도', 
                           '충청북도', '충청남도', '전라북도', '전라남도', '경상북도', 
                           '경상남도', '제주특별자치도'];

            // 결정론적 가중치 (BDS 개선에 대한 정책별 기여)
            const baseEffects = {
                population: 0.10,
                industry: 0.15,
                infrastructure: 0.12,
                institutional: 0.08
            };
            
            regions.forEach(region => {
                const baseline = typeof bdsBaselineByRegion[region] === 'number' ? bdsBaselineByRegion[region] : null;
                let regionDelta = 0;
                let regionCost = 0;
                Object.keys(parameters).forEach(policyKey => {
                    const params = parameters[policyKey];
                    const effect = params.intensity * params.duration * baseEffects[policyKey] * 0.01; // 1pp 단위
                    const cost = params.intensity * params.duration * 5; // 결정론적 비용
                    regionDelta += effect;
                    regionCost += cost;
                });
                const risk = regionCost * 0.30;
                results.regionalEffects[region] = {
                    improvement: regionDelta,
                    baseline: baseline,
                    improved_bds: baseline == null ? null : baseline + (regionDelta * 100),
                    cost: regionCost,
                    risk: risk
                };
                totalImprovement += regionDelta;
                totalCost += regionCost;
                totalRisk += risk;
            });
            
            results.bdsImprovement = totalImprovement / regions.length;
            results.totalCost = totalCost;
            results.totalRisk = totalRisk;
            return results;
        }

        // 재정자립도 시뮬레이션 함수
        function simulateFiscal(parameters) {
            const results = {
                fiscalImprovement: 0,
                regionalEffects: {},
                totalCost: 0,
                totalRisk: 0
            };
            
            let totalImprovement = 0;
            let totalCost = 0;
            let totalRisk = 0;
            
            // 17개 지역에 대한 시뮬레이션
            const regions = ['서울특별시', '부산광역시', '대구광역시', '인천광역시', '광주광역시', 
                           '대전광역시', '울산광역시', '세종특별자치시', '경기도', '강원도', 
                           '충청북도', '충청남도', '전라북도', '전라남도', '경상북도', 
                           '경상남도', '제주특별자치도'];
            
            regions.forEach((region) => {
                // 측정된 최신연도 기준선
                const baseline = fiscalBaselineByRegion[region] ? fiscalBaselineByRegion[region].autonomy : 0;

                // 정책별 기본 효과 계수 (재정자립도에 대한 결정론적 가중치)
                const baseEffects = {
                    population: 0.04,
                    industry: 0.06,
                    infrastructure: 0.05,
                    institutional: 0.03
                };

                // 파라미터 합성: 강도 x 기간 x 가중치 → 퍼센트포인트 개선치
                let regionDelta = 0;
                let regionCost = 0;
                Object.keys(parameters).forEach(policyKey => {
                    const params = parameters[policyKey];
                    const effect = params.intensity * params.duration * baseEffects[policyKey] * 0.01; // 1pp = 0.01
                    const cost = params.intensity * params.duration * 8; // 단순화된 결정적 비용 모델
                    regionDelta += effect;
                    regionCost += cost;
                });

                // 개선치는 퍼센트포인트(비율 단위)
                const improvement = regionDelta;
                // 리스크: 비용의 일정 비율(결정론)
                const risk = regionCost * 0.25;

                results.regionalEffects[region] = {
                    improvement: improvement,
                    baseline: baseline,
                    improved_autonomy: baseline + improvement,
                    cost: regionCost,
                    risk: risk
                };

                totalImprovement += improvement;
                totalCost += regionCost;
                totalRisk += risk;
            });
            
            results.fiscalImprovement = totalImprovement / regions.length;
            results.totalCost = totalCost;
            results.totalRisk = totalRisk;
            
            return results;
        }

        // 결과 표시 함수
        function displayIntegratedSimulationResults(results) {
            console.log("통합 시뮬레이션 결과 표시 시작:", results);
            
            try {
                document.getElementById('bds-improvement').textContent = (results.bds.bdsImprovement * 100).toFixed(2) + '%p';
                document.getElementById('fiscal-improvement').textContent = (results.fiscal.fiscalImprovement * 100).toFixed(2) + '%p';
                document.getElementById('overall-efficiency').textContent = (results.overallEfficiency * 100).toFixed(2);
                document.getElementById('total-risk').textContent = Math.round(results.totalRisk) + '억원';
                
                console.log("지표 업데이트 완료");
                
                // 몬테카를로 시뮬레이션 차트
                const mcData = [];
                for (let i = 0; i < 1000; i++) {
                    const seed = FIXED_SEED + i;
                    const randomValue = seededRandom(seed);
                    mcData.push(randomValue * (results.bds.bdsImprovement + results.fiscal.fiscalImprovement) * 2);
                }
                
                Plotly.newPlot('monte-carlo-chart', [{
                    x: mcData,
                    type: 'histogram',
                    nbinsx: 50,
                    name: '통합 효과 분포',
                    marker: {color: '#9c27b0', opacity: 0.7}
                }], {
                    title: '몬테카를로 시뮬레이션 결과',
                    xaxis: {title: '종합 개선 효과'},
                    yaxis: {title: '빈도'},
                    height: 400
                });
                
                console.log("몬테카를로 차트 생성 완료");
                
                // 정책별 효과 분석 차트
                const policyEffects = [
                    {name: '인구 정책', bds: results.bds.bdsImprovement * 0.3, fiscal: results.fiscal.fiscalImprovement * 0.15},
                    {name: '산업 정책', bds: results.bds.bdsImprovement * 0.4, fiscal: results.fiscal.fiscalImprovement * 0.2},
                    {name: '인프라 정책', bds: results.bds.bdsImprovement * 0.35, fiscal: results.fiscal.fiscalImprovement * 0.18},
                    {name: '제도 정책', bds: results.bds.bdsImprovement * 0.25, fiscal: results.fiscal.fiscalImprovement * 0.12}
                ];
                
                const policyData = [{
                    x: policyEffects.map(p => p.name),
                    y: policyEffects.map(p => (p.bds + p.fiscal) * 100),
                    type: 'bar',
                    name: '통합 효과',
                    marker: {color: '#667eea'}
                }];
                
                Plotly.newPlot('policy-effects-chart', policyData, {
                    title: '정책별 통합 효과 분석',
                    xaxis: {title: '정책 유형'},
                    yaxis: {title: '개선 효과 (%)'},
                    height: 400
                });
                
                // BDS vs 재정자립도 비교 차트
                const comparisonData = [{
                    x: ['BDS 개선', '재정자립도 개선'],
                    y: [results.bds.bdsImprovement * 100, results.fiscal.fiscalImprovement * 100],
                    type: 'bar',
                    name: '개선 효과',
                    marker: {color: ['#667eea', '#9c27b0']}
                }];
                
                Plotly.newPlot('comparison-chart', comparisonData, {
                    title: 'BDS vs 재정자립도 개선 효과 비교',
                    xaxis: {title: '지표 유형'},
                    yaxis: {title: '개선 효과 (%)'},
                    height: 400
                });
                
                console.log("추가 차트 생성 완료");
                
                // 통합 지도 생성
                createIntegratedMap(results);
                
                console.log("통합 시뮬레이션 결과 표시 완료");
            } catch (error) {
                console.error("통합 시뮬레이션 결과 표시 오류:", error);
                alert("결과 표시 중 오류가 발생했습니다: " + error.message);
            }
        }

        // 도움말 모달 표시 함수
        function showHelpModal(modalId) {
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
        }

        // 통합 지도 생성 함수
        function createIntegratedMap(results) {
            console.log("통합 지도 생성 시작:", results);
            
            try {
                // 기존 지도가 있으면 제거
                if (window.integratedMap) {
                    window.integratedMap.remove();
                }

                // 한국 중심 좌표 (더 넓은 범위로 조정)
                const koreaCenter = [36.2, 127.8];
                
                // 지도 생성 (줌 레벨을 낮춰서 더 넓은 영역 표시)
                window.integratedMap = L.map('integrated-map').setView(koreaCenter, 6);
                
                // OpenStreetMap 타일 레이어 추가
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(window.integratedMap);

                // 한국 영역 경계 설정 (지도 이동 제한)
                const koreaBounds = [
                    [33.0, 124.5], // 남서쪽 경계
                    [38.6, 132.0]  // 북동쪽 경계
                ];
                window.integratedMap.setMaxBounds(koreaBounds);
                window.integratedMap.setMinZoom(5);
                window.integratedMap.setMaxZoom(10);

                // 색상 함수 정의
                function getColor(improvement) {
                    if (improvement >= 0.08) return '#ff0000';  // 빨간색
                    if (improvement >= 0.05) return '#ffa500';   // 주황색
                    if (improvement >= 0.03) return '#ffff00';  // 노란색
                    if (improvement >= 0.01) return '#90ee90';  // 연두색
                    return '#c0c0c0'; // 회색
                }

                // 지역별 효과 데이터 준비
                const regionEffects = {};
                const regions = ['서울특별시', '부산광역시', '대구광역시', '인천광역시', '광주광역시', 
                               '대전광역시', '울산광역시', '세종특별자치시', '경기도', '강원도', 
                               '충청북도', '충청남도', '전라북도', '전라남도', '경상북도', 
                               '경상남도', '제주특별자치도'];
                
                regions.forEach(region => {
                    const bdsEffect = results.bds.regionalEffects[region] ? results.bds.regionalEffects[region].improvement : 0;
                    const fiscalEffect = results.fiscal.regionalEffects[region] ? results.fiscal.regionalEffects[region].improvement : 0;
                    const integratedEffect = bdsEffect * 0.6 + fiscalEffect * 0.4; // BDS 60%, 재정자립도 40%
                    regionEffects[region] = integratedEffect;
                    console.log(`지역: ${region}, 효과: ${(integratedEffect * 100).toFixed(2)}%p`);
                });

                // 정확한 한국 행정구역 GeoJSON 데이터 로드
                fetch('navis_data/skorea-provinces-2018-geo.json')
                    .then(response => response.json())
                    .then(geoJsonData => {
                        console.log('GeoJSON 데이터 로드 성공:', geoJsonData.features.length, '개 지역');
                        console.log('GeoJSON 지역명들:', geoJsonData.features.map(f => f.properties.name));
                        createIntegratedMapWithGeoJSON(geoJsonData, results, regionEffects);
                    })
                    .catch(error => {
                        console.error('Error loading GeoJSON:', error);
                        // Fallback to simple markers if GeoJSON fails
                        createIntegratedMapWithSimpleMarkers(results, regionEffects);
                    });

                // GeoJSON 레이어 추가 함수들
                function createIntegratedMapWithGeoJSON(geoJsonData, results, regionEffects) {
                    console.log('regionEffects 객체:', regionEffects);
                    
                    L.geoJSON(geoJsonData, {
                        style: function(feature) {
                            const regionName = feature.properties.name;
                            const effect = regionEffects[regionName] || 0;
                            const color = getColor(effect);
                            
                            console.log(`지역: ${regionName}, 효과: ${effect}, 색상: ${color}`);
                            
                            return {
                                fillColor: color,
                                weight: 2,
                                opacity: 1,
                                color: '#333',
                                fillOpacity: 0.7
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            const regionName = feature.properties.name;
                            const bdsEffect = results.bds.regionalEffects[regionName] ? results.bds.regionalEffects[regionName].improvement : 0;
                            const fiscalEffect = results.fiscal.regionalEffects[regionName] ? results.fiscal.regionalEffects[regionName].improvement : 0;
                            const integratedEffect = regionEffects[regionName] || 0;
                            
                            // 툴팁 추가
                            layer.bindTooltip(`
                                <strong>${regionName}</strong><br>
                                BDS 개선: +${(bdsEffect * 100).toFixed(2)}%p<br>
                                재정자립도 개선: +${(fiscalEffect * 100).toFixed(2)}%p<br>
                                통합 효과: +${(integratedEffect * 100).toFixed(2)}%p
                            `);
                            
                            // 클릭 이벤트 추가
                            layer.on('click', function() {
                                console.log(`클릭된 지역: ${regionName}, 통합 효과: ${(integratedEffect * 100).toFixed(2)}%p`);
                            });
                        }
                    }).addTo(window.integratedMap);
                }

                function createIntegratedMapWithSimpleMarkers(results, regionEffects) {
                    // 간단한 원형 마커로 대체
                    const regions = ['서울특별시', '부산광역시', '대구광역시', '인천광역시', '광주광역시', 
                                   '대전광역시', '울산광역시', '세종특별자치시', '경기도', '강원도', 
                                   '충청북도', '충청남도', '전라북도', '전라남도', '경상북도', 
                                   '경상남도', '제주특별자치도'];
                    
                    const regionCoordinates = {
                        '서울특별시': [37.5665, 126.9780],
                        '부산광역시': [35.1796, 129.0756],
                        '대구광역시': [35.8714, 128.6014],
                        '인천광역시': [37.4563, 126.7052],
                        '광주광역시': [35.1595, 126.8526],
                        '대전광역시': [36.3504, 127.3845],
                        '울산광역시': [35.5384, 129.3114],
                        '세종특별자치시': [36.4800, 127.2890],
                        '경기도': [37.4138, 127.5183],
                        '강원도': [37.8228, 128.1555],
                        '충청북도': [36.8000, 127.7000],
                        '충청남도': [36.5184, 126.8000],
                        '전라북도': [35.7175, 127.1530],
                        '전라남도': [34.8679, 126.9910],
                        '경상북도': [36.4919, 128.8889],
                        '경상남도': [35.4606, 128.2132],
                        '제주특별자치도': [33.4996, 126.5312]
                    };
                    
                    regions.forEach(region => {
                        const coords = regionCoordinates[region];
                        if (coords) {
                            const effect = regionEffects[region] || 0;
                            const color = getColor(effect);
                            const radius = Math.max(5, Math.min(20, Math.abs(effect) * 1000));
                            
                            const bdsEffect = results.bds.regionalEffects[region] ? results.bds.regionalEffects[region].improvement : 0;
                            const fiscalEffect = results.fiscal.regionalEffects[region] ? results.fiscal.regionalEffects[region].improvement : 0;
                            
                            L.circle(coords, {
                                color: color,
                                fillColor: color,
                                fillOpacity: 0.7,
                                radius: radius * 1000
                            }).bindTooltip(`
                                <strong>${region}</strong><br>
                                BDS 개선: +${(bdsEffect * 100).toFixed(2)}%p<br>
                                재정자립도 개선: +${(fiscalEffect * 100).toFixed(2)}%p<br>
                                통합 효과: +${(effect * 100).toFixed(2)}%p
                            `).addTo(window.integratedMap);
                        }
                    });
                }

                // 범례 추가
                const legend = L.control({position: 'bottomright'});
                legend.onAdd = function(map) {
                    const div = L.DomUtil.create('div', 'region-legend');
                    div.innerHTML = `
                        <h6>통합 개선 효과</h6>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ff0000;"></div>
                            <span>0.08%p 이상</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ffa500;"></div>
                            <span>0.05-0.08%p</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ffff00;"></div>
                            <span>0.03-0.05%p</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #90ee90;"></div>
                            <span>0.01-0.03%p</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #c0c0c0;"></div>
                            <span>0.01%p 미만</span>
                        </div>
                    `;
                    return div;
                };
                legend.addTo(window.integratedMap);
                
                console.log("통합 지도 생성 완료");
            } catch (error) {
                console.error("통합 지도 생성 오류:", error);
                alert("지도 생성 중 오류가 발생했습니다: " + error.message);
            }
        }
    </script>

    <!-- 도움말 모달들 -->
    <!-- 통합 효과 지도 모달 -->
    <div class="modal fade" id="integratedMapModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-map"></i> 통합 효과 지도 설명</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>지도 해석 방법</h6>
                    <p>이 지도는 BDS(지역균형발전지수)와 재정자립도를 통합한 정책 효과를 지역별로 시각화합니다.</p>
                    
                    <h6>색상 의미</h6>
                    <ul>
                        <li><strong>빨간색</strong>: 0.08%p 이상의 높은 개선 효과</li>
                        <li><strong>주황색</strong>: 0.05-0.08%p의 중간 개선 효과</li>
                        <li><strong>노란색</strong>: 0.03-0.05%p의 보통 개선 효과</li>
                        <li><strong>연두색</strong>: 0.01-0.03%p의 낮은 개선 효과</li>
                        <li><strong>회색</strong>: 0.01%p 미만의 미미한 개선 효과</li>
                    </ul>
                    
                    <h6>원형 마커</h6>
                    <p>각 지역의 원형 마커 크기는 통합 개선 효과의 크기를 나타냅니다. 마커를 클릭하면 상세 정보를 확인할 수 있습니다.</p>
                    
                    <h6>학술적 근거</h6>
                    <p>이 시뮬레이션은 지역균형발전지수(BDS)와 재정자립도 간의 상관관계를 기반으로 하며, 
                    Kim et al. (2023)의 지역발전 정책 효과 분석 모델을 참조하여 구현되었습니다.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 몬테카를로 시뮬레이션 모달 -->
    <div class="modal fade" id="monteCarloModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-dice"></i> 몬테카를로 시뮬레이션 설명</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>몬테카를로 시뮬레이션이란?</h6>
                    <p>몬테카를로 시뮬레이션은 확률적 불확실성을 고려하여 정책 효과의 분포를 분석하는 방법입니다.</p>
                    
                    <h6>시뮬레이션 과정</h6>
                    <ol>
                        <li>1,000회의 반복 시뮬레이션 수행</li>
                        <li>각 반복마다 랜덤 변수 적용</li>
                        <li>BDS와 재정자립도 개선 효과의 통합 분포 계산</li>
                        <li>결과의 확률 분포 시각화</li>
                    </ol>
                    
                    <h6>해석 방법</h6>
                    <ul>
                        <li><strong>가장 높은 막대</strong>: 가장 빈번한 개선 효과 수준</li>
                        <li><strong>분포의 폭</strong>: 정책 효과의 불확실성 정도</li>
                        <li><strong>분포의 위치</strong>: 평균적인 정책 효과 수준</li>
                    </ul>
                    
                    <h6>학술적 근거</h6>
                    <p>이 방법은 정책 분석에서 불확실성을 정량화하는 표준적인 접근법으로, 
                    OECD (2021)의 정책 효과 평가 가이드라인을 따릅니다.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 정책별 효과 분석 모달 -->
    <div class="modal fade" id="policyEffectsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-chart-pie"></i> 정책별 효과 분석 설명</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>정책별 효과 비교</h6>
                    <p>이 차트는 4가지 정책 유형별로 BDS와 재정자립도에 미치는 통합 효과를 비교합니다.</p>
                    
                    <h6>정책 유형별 특징</h6>
                    <ul>
                        <li><strong>산업 정책</strong>: 가장 높은 BDS 개선 효과 (0.4), 중간 재정자립도 효과 (0.2)</li>
                        <li><strong>인프라 정책</strong>: 높은 BDS 개선 효과 (0.35), 중간 재정자립도 효과 (0.18)</li>
                        <li><strong>인구 정책</strong>: 중간 BDS 개선 효과 (0.3), 낮은 재정자립도 효과 (0.15)</li>
                        <li><strong>제도 정책</strong>: 낮은 BDS 개선 효과 (0.25), 가장 낮은 재정자립도 효과 (0.12)</li>
                    </ul>
                    
                    <h6>효과 계산 방식</h6>
                    <p>각 정책의 통합 효과 = (BDS 개선 효과 × 0.6) + (재정자립도 개선 효과 × 0.4)</p>
                    
                    <h6>학술적 근거</h6>
                    <p>정책별 효과 계수는 한국개발연구원(KDI)의 지역발전 정책 효과 분석 보고서(2022)를 기반으로 설정되었습니다.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- BDS vs 재정자립도 비교 모달 -->
    <div class="modal fade" id="comparisonModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-chart-line"></i> BDS vs 재정자립도 비교 설명</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>지표 비교의 의미</h6>
                    <p>이 차트는 BDS(지역균형발전지수)와 재정자립도 개선 효과를 직접 비교하여 정책의 균형성을 평가합니다.</p>
                    
                    <h6>BDS (지역균형발전지수)</h6>
                    <ul>
                        <li>지역 간 발전 격차를 종합적으로 측정하는 지표</li>
                        <li>경제, 사회, 환경 요소를 통합하여 계산</li>
                        <li>높을수록 지역 간 균형발전이 잘 이루어짐을 의미</li>
                    </ul>
                    
                    <h6>재정자립도</h6>
                    <ul>
                        <li>지방자치단체의 자체 수입 능력을 나타내는 지표</li>
                        <li>지방세 수입 / 총 수입 × 100으로 계산</li>
                        <li>높을수록 재정적 자립성이 높음을 의미</li>
                    </ul>
                    
                    <h6>균형적 정책 수립</h6>
                    <p>이상적인 정책은 두 지표 모두를 균형있게 개선하는 것입니다. 
                    한쪽에만 치우친 정책은 지속가능한 지역발전을 저해할 수 있습니다.</p>
                    
                    <h6>학술적 근거</h6>
                    <p>이 비교 분석은 국토교통부의 지역균형발전 종합계획(2021-2025)의 
                    정책 효과 평가 방법론을 참조하여 구현되었습니다.</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
