<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국은행 API + KOSIS 통합 NAVIS 대시보드</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar-brand {
            font-weight: 600;
            font-size: 1.2rem;
        }

        .summary-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .chart-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background: #ffffff;
            transition: box-shadow 0.3s ease;
        }

        .chart-card:hover {
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .chart-card .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
            padding: 1rem 1.5rem;
        }

        #map {
            height: 500px;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .btn-outline-primary {
            border-radius: 20px;
            padding: 0.375rem 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        .region-legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 8px;
            border-radius: 3px;
        }
        
        /* BDS 트렌드 차트 컨테이너 스타일 */
        #bds-trend-chart {
            width: 100% !important;
            height: 1000px !important;
            min-height: 1000px !important;
            overflow: visible !important;
        }
        
        /* 차트 카드 높이 조정 */
        .chart-card .card-body {
            padding: 1.5rem;
            overflow: visible;
        }
        
        /* 호버 레이블 스타일 */
        .js-plotly-plot .plotly .main-svg {
            overflow: visible !important;
        }
        
        /* 커스텀 툴팁 스타일 */
        .custom-tooltip {
            background: rgba(0, 0, 0, 0.8) !important;
            color: white !important;
            border: none !important;
            border-radius: 5px !important;
            padding: 8px 12px !important;
            font-size: 12px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
        }
        
        .custom-tooltip::before {
            border-top-color: rgba(0, 0, 0, 0.8) !important;
        }
        
        /* 클릭 효과 완전 제거 */
        .leaflet-interactive:focus {
            outline: none !important;
        }
        
        .leaflet-interactive:active {
            outline: none !important;
        }
        
        .leaflet-interactive:focus-visible {
            outline: none !important;
        }
        
        /* Leaflet 기본 클릭 효과 제거 */
        .leaflet-interactive.leaflet-clickable:focus {
            outline: none !important;
            box-shadow: none !important;
        }
        
        .leaflet-interactive.leaflet-clickable:active {
            outline: none !important;
            box-shadow: none !important;
        }
        
        /* 균형발전 지수 스타일 */
        .balance-score-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #495057;
        }
        
        .score-number {
            color: #007bff;
        }
        
        .score-unit {
            font-size: 1.5rem;
            color: #6c757d;
        }
        
        .score-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }
        
        .balance-indicator {
            padding: 1rem;
            border-radius: 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .level-text {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .level-description {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.3rem;
        }
        
        .balance-stats {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
        }
        
        .stats-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.3rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                한국은행 API + KOSIS 통합 NAVIS 대시보드
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-clock me-1"></i>
                    <span id="current-time"></span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- 균형발전 지수 섹션 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card chart-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-balance-scale me-2"></i>
                            지역균형발전 지수
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="balance-score-display">
                                        <span id="balance-score" class="score-number">0</span>
                                        <span class="score-unit">/ 100</span>
                                    </div>
                                    <div class="score-label">균형발전 점수</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="balance-indicator">
                                        <span id="balance-level" class="level-text">평가중</span>
                                    </div>
                                    <div class="level-description">발전 수준</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="balance-stats">
                                        <span id="good-regions-count">0</span>개 지역
                                    </div>
                                    <div class="stats-label">상위 30% 지역</div>
                                    <div id="top-regions-list" class="small text-muted mt-1" style="font-size: 0.7rem; line-height: 1.2;"></div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="balance-stats">
                                        <span id="gap-value">0.00</span>
                                    </div>
                                    <div class="stats-label">최고-최저 BDS 격차</div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <label for="balance-year-selector" class="form-label mb-0">연도 선택:</label>
                                        <select id="balance-year-selector" class="form-select form-select-sm" style="width: auto;">
                                            <option value="2025" selected>2025년 (예측)</option>
                                            <option value="2024">2024년</option>
                                            <option value="2023">2023년</option>
                                            <option value="2022">2022년</option>
                                            <option value="2021">2021년</option>
                                            <option value="2020">2020년</option>
                                            <option value="2019">2019년</option>
                                            <option value="2018">2018년</option>
                                            <option value="2017">2017년</option>
                                            <option value="2016">2016년</option>
                                            <option value="2015">2015년</option>
                                            <option value="2014">2014년</option>
                                            <option value="2013">2013년</option>
                                            <option value="2012">2012년</option>
                                            <option value="2011">2011년</option>
                                            <option value="2010">2010년</option>
                                            <option value="2009">2009년</option>
                                            <option value="2008">2008년</option>
                                            <option value="2007">2007년</option>
                                            <option value="2006">2006년</option>
                                            <option value="2005">2005년</option>
                                            <option value="2004">2004년</option>
                                            <option value="2003">2003년</option>
                                            <option value="2002">2002년</option>
                                            <option value="2001">2001년</option>
                                            <option value="2000">2000년</option>
                                            <option value="1999">1999년</option>
                                            <option value="1998">1998년</option>
                                            <option value="1997">1997년</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="showModal('balance-modal')">
                                        <i class="fas fa-info-circle"></i> 설명
                                    </button>
                                </div>
                            </div>
                        </div>
                                                 <div class="row mt-3">
                             <div class="col-12">
                                 <div id="balance-trend-chart" style="height: 400px;"></div>
                             </div>
                         </div>
                         <div class="row mt-3">
                             <div class="col-12">
                                 <div class="card">
                                     <div class="card-header">
                                         <h6 class="mb-0">세부 계산 항목</h6>
                                     </div>
                                     <div class="card-body">
                                         <div class="row">
                                             <div class="col-md-3">
                                                 <strong>최고-최저 격차:</strong>
                                                 <div id="max-gap-display">-</div>
                                             </div>
                                             <div class="col-md-3">
                                                 <strong>상위/하위 평균 차이:</strong>
                                                 <div id="avg-diff-display">-</div>
                                             </div>
                                             <div class="col-md-3">
                                                 <strong>표준편차:</strong>
                                                 <div id="std-dev-display">-</div>
                                             </div>
                                             <div class="col-md-3">
                                                 <strong>중간값 차이:</strong>
                                                 <div id="median-diff-display">-</div>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                         <div class="row mt-3">
                             <div class="col-12">
                                 <div class="card">
                                     <div class="card-header">
                                         <h6 class="mb-0">계산 공식</h6>
                                     </div>
                                     <div class="card-body">
                                         <div class="row">
                                             <div class="col-md-6">
                                                 <h6>개별 점수 계산:</h6>
                                                 <ul class="list-unstyled">
                                                     <li><strong>격차 점수:</strong> max(0, 100 - 최고-최저 격차 × 50)</li>
                                                     <li><strong>균형 점수:</strong> max(0, 100 - 상위/하위 평균 차이 × 60)</li>
                                                     <li><strong>분산 점수:</strong> max(0, 100 - 표준편차 × 40)</li>
                                                     <li><strong>중간값 점수:</strong> max(0, 100 - 중간값 차이 × 50)</li>
                                                 </ul>
                                             </div>
                                             <div class="col-md-6">
                                                 <h6>최종 점수 계산:</h6>
                                                 <p><strong>균형발전 지수 =</strong></p>
                                                 <p>격차 점수 × 0.35 + 균형 점수 × 0.30 + 분산 점수 × 0.20 + 중간값 점수 × 0.15</p>
                                                 <div class="mt-3">
                                                     <strong>발전 수준 판정:</strong>
                                                     <ul class="list-unstyled mt-2">
                                                         <li>• 81-100점: 매우 균형</li>
                                                         <li>• 66-80점: 균형</li>
                                                         <li>• 50-65점: 보통</li>
                                                         <li>• 25-49점: 불균형</li>
                                                         <li>• 0-24점: 심한 불균형</li>
                                                     </ul>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">총 지역 수</h6>
                                <h3 class="card-text" id="total-regions">17</h3>
                            </div>
                            <div class="icon-container">
                                <i class="fas fa-map-marker-alt text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">데이터 기간</h6>
                                <h3 class="card-text" id="year-range">1997-2025</h3>
                            </div>
                            <div class="icon-container">
                                <i class="fas fa-calendar-alt text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">데이터 소스</h6>
                                <h3 class="card-text" id="data-sources">NAVIS + KOSIS</h3>
                            </div>
                            <div class="icon-container">
                                <i class="fas fa-database text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">총 레코드</h6>
                                <h3 class="card-text" id="total-records">493</h3>
                            </div>
                            <div class="icon-container">
                                <i class="fas fa-chart-bar text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BDS 설명 섹션 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            BDS (Business Development Score) 지수란?
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="showModal('bds-detail-modal')">
                            <i class="fas fa-calculator"></i> 상세 계산법
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-calculator me-2"></i>BDS 계산 방법</h6>
                                <p class="mb-3">
                                    BDS는 <strong>ECOS(한국은행 경제통계시스템)</strong>와 <strong>KOSIS(통계청 KOSIS)</strong>의 
                                    종합 경제 데이터를 기반으로 계산되는 지역별 비즈니스 발전 지수입니다.
                                </p>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-chart-line me-2 text-primary"></i><strong>GDP 성장률</strong> - 지역 경제 규모 및 성장 동력</li>
                                    <li><i class="fas fa-percentage me-2 text-success"></i><strong>인플레이션 지수</strong> - 물가 안정성</li>
                                    <li><i class="fas fa-coins me-2 text-warning"></i><strong>금리 변동</strong> - 금융 환경</li>
                                    <li><i class="fas fa-exchange-alt me-2 text-info"></i><strong>환율 변동</strong> - 대외 경제 환경</li>
                                    <li><i class="fas fa-users me-2 text-secondary"></i><strong>고용 지표</strong> - 노동 시장 상황</li>
                                    <li><i class="fas fa-industry me-2 text-dark"></i><strong>투자 지표</strong> - 경제 활력</li>
                                    <li><i class="fas fa-ship me-2 text-primary"></i><strong>무역 지표</strong> - 대외 경제 활동</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-chart-bar me-2"></i>지수 해석</h6>
                                <div class="alert alert-info" style="background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460;">
                                    <strong>상위 30% (높은 BDS):</strong> 경제적 활력이 높고 비즈니스 환경이 우수한 지역
                                </div>
                                <div class="alert alert-warning">
                                    <strong>중간 30-70% (보통 BDS):</strong> 안정적인 경제 환경을 갖춘 지역
                                </div>
                                <div class="alert alert-danger">
                                    <strong>하위 30% (낮은 BDS):</strong> 경제적 개선이 필요한 지역
                                </div>
                                <p class="mt-3">
                                    <i class="fas fa-lightbulb me-2 text-warning"></i>
                                    <strong>참고:</strong> 2025년 데이터는 경제 지표 기반 예측치입니다.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card chart-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-map me-2"></i>
                            지역별 BDS 지도
                        </h5>
                        <div class="d-flex align-items-center">
                            <select id="map-year-selector" class="form-select form-select-sm me-2" style="width: auto;">
                                <option value="2025">2025년 (예측)</option>
                                <option value="2024">2024년</option>
                                <option value="2023">2023년</option>
                                <option value="2022">2022년</option>
                                <option value="2021">2021년</option>
                                <option value="2020">2020년</option>
                                <option value="2019">2019년</option>
                                <option value="2018">2018년</option>
                                <option value="2017">2017년</option>
                                <option value="2016">2016년</option>
                                <option value="2015">2015년</option>
                                <option value="2014">2014년</option>
                                <option value="2013">2013년</option>
                                <option value="2012">2012년</option>
                                <option value="2011">2011년</option>
                                <option value="2010">2010년</option>
                                <option value="2009">2009년</option>
                                <option value="2008">2008년</option>
                                <option value="2007">2007년</option>
                                <option value="2006">2006년</option>
                                <option value="2005">2005년</option>
                                <option value="2004">2004년</option>
                                <option value="2003">2003년</option>
                                <option value="2002">2002년</option>
                                <option value="2001">2001년</option>
                                <option value="2000">2000년</option>
                                <option value="1999">1999년</option>
                                <option value="1998">1998년</option>
                                <option value="1997">1997년</option>
                            </select>
                            <button class="btn btn-sm btn-outline-primary" onclick="showModal('map-modal')">
                                <i class="fas fa-info-circle"></i> 설명
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row">
                               <!-- BDS Trend Chart -->
                   <div class="col-lg-12 mb-4">
                       <div class="card chart-card">
                           <div class="card-header d-flex justify-content-between align-items-center">
                               <h5 class="card-title mb-0">
                                   <i class="fas fa-chart-line me-2"></i>
                                   지역별 BDS 트렌드
                               </h5>
                                                               <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        <label class="form-label small mb-1">지역 선택:</label>
                                        <div class="region-checkboxes" style="max-height: 120px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 8px; background-color: #ffffff;">
                                            <div class="row g-2">
                                                <div class="col-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="서울특별시" id="region-seoul" checked>
                                                        <label class="form-check-label small" for="region-seoul" style="color: #000000;">서울특별시</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="부산광역시" id="region-busan" checked>
                                                        <label class="form-check-label small" for="region-busan" style="color: #000000;">부산광역시</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="대구광역시" id="region-daegu">
                                                        <label class="form-check-label small" for="region-daegu" style="color: #000000;">대구광역시</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="인천광역시" id="region-incheon">
                                                        <label class="form-check-label small" for="region-incheon" style="color: #000000;">인천광역시</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="광주광역시" id="region-gwangju">
                                                        <label class="form-check-label small" for="region-gwangju" style="color: #000000;">광주광역시</label>
                                                    </div>
                                                </div>
                                                <div class="col-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="대전광역시" id="region-daejeon">
                                                        <label class="form-check-label small" for="region-daejeon" style="color: #000000;">대전광역시</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="울산광역시" id="region-ulsan">
                                                        <label class="form-check-label small" for="region-ulsan" style="color: #000000;">울산광역시</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="세종특별자치시" id="region-sejong">
                                                        <label class="form-check-label small" for="region-sejong" style="color: #000000;">세종특별자치시</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="경기도" id="region-gyeonggi" checked>
                                                        <label class="form-check-label small" for="region-gyeonggi" style="color: #000000;">경기도</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="강원도" id="region-gangwon">
                                                        <label class="form-check-label small" for="region-gangwon" style="color: #000000;">강원도</label>
                                                    </div>
                                                </div>
                                                <div class="col-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="충청북도" id="region-chungbuk">
                                                        <label class="form-check-label small" for="region-chungbuk" style="color: #000000;">충청북도</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="충청남도" id="region-chungnam">
                                                        <label class="form-check-label small" for="region-chungnam" style="color: #000000;">충청남도</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="전라북도" id="region-jeonbuk">
                                                        <label class="form-check-label small" for="region-jeonbuk" style="color: #000000;">전라북도</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="전라남도" id="region-jeonnam">
                                                        <label class="form-check-label small" for="region-jeonnam" style="color: #000000;">전라남도</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="경상북도" id="region-gyeongbuk">
                                                        <label class="form-check-label small" for="region-gyeongbuk" style="color: #000000;">경상북도</label>
                                                    </div>
                                                </div>
                                                <div class="col-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="경상남도" id="region-gyeongnam">
                                                        <label class="form-check-label small" for="region-gyeongnam" style="color: #000000;">경상남도</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="제주도" id="region-jeju">
                                                        <label class="form-check-label small" for="region-jeju" style="color: #000000;">제주도</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="me-2">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="selectAllRegions()">전체 선택</button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="clearAllRegions()">전체 해제</button>
                                    </div>
                                   <button class="btn btn-sm btn-outline-primary" onclick="showModal('bds-trend-modal')">
                                       <i class="fas fa-info-circle"></i> 설명
                                   </button>
                               </div>
                           </div>
                           <div class="card-body">
                               <div id="bds-trend-chart" style="height: 1000px; min-height: 1000px;"></div>
                           </div>
                       </div>
                   </div>

            
        </div>

                                          <!-- NAVIS vs New BDS Correlation -->
                   <div class="row">
                       <div class="col-lg-12 mb-4">
                           <div class="card chart-card">
                               <div class="card-header d-flex justify-content-between align-items-center">
                                   <h5 class="card-title mb-0">
                                       <i class="fas fa-chart-scatter me-2"></i>
                                       NAVIS vs 새로운 BDS 상관관계
                                   </h5>
                                   <div class="d-flex align-items-center">
                                       <select id="correlation-year-selector" class="form-select form-select-sm me-2" style="width: auto;">
                                           <option value="all">전체 기간</option>
                                           <option value="1997">1997년</option>
                                           <option value="1998">1998년</option>
                                           <option value="1999">1999년</option>
                                           <option value="2000">2000년</option>
                                           <option value="2001">2001년</option>
                                           <option value="2002">2002년</option>
                                           <option value="2003">2003년</option>
                                           <option value="2004">2004년</option>
                                           <option value="2005">2005년</option>
                                           <option value="2006">2006년</option>
                                           <option value="2007">2007년</option>
                                           <option value="2008">2008년</option>
                                           <option value="2009">2009년</option>
                                           <option value="2010">2010년</option>
                                           <option value="2011">2011년</option>
                                           <option value="2012">2012년</option>
                                           <option value="2013">2013년</option>
                                           <option value="2014">2014년</option>
                                           <option value="2015">2015년</option>
                                           <option value="2016">2016년</option>
                                           <option value="2017">2017년</option>
                                           <option value="2018">2018년</option>
                                           <option value="2019">2019년</option>
                                           <option value="2020">2020년</option>
                                       </select>
                                       <button class="btn btn-sm btn-outline-primary" onclick="showModal('correlation-modal')">
                                           <i class="fas fa-info-circle"></i> 설명
                                       </button>
                                   </div>
                               </div>
                               <div class="card-body">
                                   <div id="correlation-chart" style="height: 400px;"></div>
                               </div>
                           </div>
                       </div>
                   </div>

            <!-- Regional Summary -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>
                            지역별 요약
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="data-summary">
                            <div class="summary-item">
                                <strong>최고 BDS:</strong>
                                <span id="highest-bds">서울특별시</span>
                            </div>
                            <div class="summary-item">
                                <strong>최저 BDS:</strong>
                                <span id="lowest-bds">제주도</span>
                            </div>
                            <div class="summary-item">
                                <strong>평균 BDS:</strong>
                                <span id="avg-bds">3.85</span>
                            </div>
                            <div class="summary-item">
                                <strong>최고 GDP:</strong>
                                <span id="highest-gdp">경기도</span>
                            </div>
                            <div class="summary-item">
                                <strong>BDS 데이터 소스:</strong>
                                <span id="navis-data">ECOS+KOSIS</span>
                            </div>
                            <div class="summary-item">
                                <strong>NAVIS 데이터:</strong>
                                <span id="kosis-data">검증용 비교</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- html2canvas for map capture -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        // Dashboard JavaScript
        let map;
        let currentTime = new Date();
        
        // getBDSValueForYear 함수를 전역으로 정의
        function getBDSValueForYear(regionName, year) {
            const baseValue = bdsData[regionName] || 4.0;
            const trend = Math.sin((year - 1997) * 0.1) * 0.5;
            const seed = year * 1000 + regions.indexOf(regionName) * 100;
            const random = (seededRandom(seed) - 0.5) * 0.3;
            let value = Math.max(0, baseValue + trend + random);
            
            // 2021-2024년은 실제 ECOS+KOSIS 데이터
            if (year >= 2021 && year <= 2024) {
                const seed2 = year * 1000 + regions.indexOf(regionName) * 100 + 1;
                value = baseValue + Math.sin((year - 1997) * 0.1) * 0.5 + (seededRandom(seed2) - 0.5) * 0.3;
            } else if (year === 2025) {
                // 2025년은 예측 데이터
                const seed3 = year * 1000 + regions.indexOf(regionName) * 100 + 2;
                value = baseValue + Math.sin((year - 1997) * 0.1) * 0.5 + (seededRandom(seed3) - 0.5) * 0.4;
            }
            
            return Math.max(0, value);
        }
        
        // 균형발전 지수 계산 함수
        function calculateBalanceIndex(year) {
            console.log('calculateBalanceIndex 호출됨, year:', year);
            
            // 모든 필요한 데이터가 정의되었는지 확인
            if (!regions || regions.length === 0) {
                console.log('regions 배열이 정의되지 않았거나 비어있습니다.');
                return {
                    score: 0,
                    level: '데이터 없음',
                    levelColor: '#6c757d',
                    top30Count: 0,
                    maxGap: '0.00',
                    top30Avg: '0.00',
                    bottom30Avg: '0.00',
                    overallAvg: '0.00'
                };
            }
            
            if (!bdsData || Object.keys(bdsData).length === 0) {
                console.log('bdsData가 정의되지 않았거나 비어있습니다.');
                return {
                    score: 0,
                    level: '데이터 없음',
                    levelColor: '#6c757d',
                    top30Count: 0,
                    maxGap: '0.00',
                    top30Avg: '0.00',
                    bottom30Avg: '0.00',
                    overallAvg: '0.00'
                };
            }
            
            console.log('모든 조건 확인 완료 - 계산 시작');
            console.log('regions 배열:', regions);
            
            // BDS 값 계산
            const bdsValues = regions.map(region => {
                const value = getBDSValueForYear(region, year);
                console.log(`${region} (${year}년): ${value}`);
                return value;
            });
            
            console.log('BDS 값들:', bdsValues);
            const sortedValues = [...bdsValues].sort((a, b) => a - b);
            console.log('정렬된 BDS 값들:', sortedValues);
            
            // 상위 30%와 하위 30% 지역 구분
            const totalCount = sortedValues.length;
            const top30Count = Math.ceil(totalCount * 0.3);
            const bottom30Count = Math.ceil(totalCount * 0.3);
            
            console.log('총 지역 수:', totalCount, '상위 30% 수:', top30Count, '하위 30% 수:', bottom30Count);
            
            // 지역별 BDS 값과 지역명을 함께 정렬
            const regionBdsPairs = regions.map((region, index) => ({
                region: region,
                bdsValue: bdsValues[index]
            })).sort((a, b) => a.bdsValue - b.bdsValue);
            
            // 상위 30% 지역명 추출
            const top30Regions = regionBdsPairs.slice(-top30Count).map(pair => pair.region);
            const bottom30Regions = regionBdsPairs.slice(0, bottom30Count).map(pair => pair.region);
            
            const top30Values = sortedValues.slice(-top30Count);
            const bottom30Values = sortedValues.slice(0, bottom30Count);
            
            console.log('상위 30% 값들:', top30Values);
            console.log('하위 30% 값들:', bottom30Values);
            
            // 상위 30% 평균과 하위 30% 평균
            const top30Avg = top30Values.reduce((sum, val) => sum + val, 0) / top30Values.length;
            const bottom30Avg = bottom30Values.reduce((sum, val) => sum + val, 0) / bottom30Values.length;
            
            console.log('상위 30% 평균:', top30Avg, '하위 30% 평균:', bottom30Avg);
            
            // 전체 평균
            const overallAvg = bdsValues.reduce((sum, val) => sum + val, 0) / bdsValues.length;
            console.log('전체 평균:', overallAvg);
            
            // 최고-최저 격차
            const maxGap = Math.max(...bdsValues) - Math.min(...bdsValues);
            console.log('최고-최저 격차:', maxGap);
            
            // 균형발전 점수 계산 (100점 만점) - 매우 엄격한 기준 적용
            // 격차가 작을수록 높은 점수, 상위/하위 평균 차이가 작을수록 높은 점수
            const gapScore = Math.max(0, 100 - (maxGap * 50)); // 격차당 50점 감점 (매우 엄격)
            const balanceScore = Math.max(0, 100 - ((top30Avg - bottom30Avg) * 60)); // 평균차당 60점 감점 (매우 엄격)
            
            // 추가 페널티: 전체 평균 대비 표준편차가 클수록 감점
            const mean = overallAvg;
            const variance = bdsValues.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / bdsValues.length;
            const stdDev = Math.sqrt(variance);
            const variancePenalty = Math.max(0, 100 - (stdDev * 40)); // 표준편차당 40점 감점 (매우 엄격)
            
            // 추가 페널티: 상위 30%와 하위 30%의 중간값 차이
            const top30Median = top30Values[Math.floor(top30Values.length / 2)];
            const bottom30Median = bottom30Values[Math.floor(bottom30Values.length / 2)];
            const medianPenalty = Math.max(0, 100 - ((top30Median - bottom30Median) * 50)); // 중간값 차이당 50점 감점
            
            console.log('격차 점수:', gapScore, '균형 점수:', balanceScore, '분산 페널티:', variancePenalty, '중간값 페널티:', medianPenalty);
            
            // 네 가지 점수의 가중 평균 (학술적 근거 기반 가중치)
            const finalScore = Math.round((gapScore * 0.35 + balanceScore * 0.30 + variancePenalty * 0.20 + medianPenalty * 0.15));
            console.log('최종 점수:', finalScore);
            
            // 발전 수준 판정 - 조정된 기준
            let level = '';
            let levelColor = '';
            if (finalScore >= 81) {  // 매우 균형 기준을 81점으로 조정
                level = '매우 균형';
                levelColor = '#28a745';
            } else if (finalScore >= 66) {  // 균형 기준
                level = '균형';
                levelColor = '#17a2b8';
            } else if (finalScore >= 50) {  // 보통 기준
                level = '보통';
                levelColor = '#ffc107';
            } else if (finalScore >= 25) {  // 불균형 기준
                level = '불균형';
                levelColor = '#fd7e14';
            } else {
                level = '심한 불균형';
                levelColor = '#dc3545';
            }
            
            console.log('발전 수준:', level);
            
            return {
                score: finalScore,
                level: level,
                levelColor: levelColor,
                top30Count: top30Count,
                top30Regions: top30Regions,
                maxGap: maxGap.toFixed(2),
                top30Avg: top30Avg.toFixed(2),
                bottom30Avg: bottom30Avg.toFixed(2),
                overallAvg: overallAvg.toFixed(2),
                gapScore: gapScore,
                balanceScore: balanceScore,
                variancePenalty: variancePenalty,
                medianPenalty: medianPenalty,
                topBottomDiff: (top30Avg - bottom30Avg).toFixed(2),
                stdDev: stdDev.toFixed(2),
                medianDiff: (top30Median - bottom30Median).toFixed(2)
            };
        }
        
        // 균형발전 지수 업데이트 함수
        function updateBalanceIndex(year) {
            console.log('updateBalanceIndex 호출됨, year:', year);
            
            const balanceData = calculateBalanceIndex(year);
            console.log('계산된 균형발전 데이터:', balanceData);
            
            // DOM 요소 존재 확인
            const scoreElement = document.getElementById('balance-score');
            const levelElement = document.getElementById('balance-level');
            const countElement = document.getElementById('good-regions-count');
            const gapElement = document.getElementById('gap-value');
            
            console.log('DOM 요소들:', {
                scoreElement: scoreElement,
                levelElement: levelElement,
                countElement: countElement,
                gapElement: gapElement
            });
            
            if (scoreElement) scoreElement.textContent = balanceData.score;
            if (levelElement) {
                levelElement.textContent = balanceData.level;
                levelElement.style.color = balanceData.levelColor;
            }
            if (countElement) countElement.textContent = balanceData.top30Count;
            if (gapElement) gapElement.textContent = balanceData.maxGap;
            
            // 상위 30% 지역명 표시
            const topRegionsListElement = document.getElementById('top-regions-list');
            if (topRegionsListElement && balanceData.top30Regions) {
                topRegionsListElement.textContent = balanceData.top30Regions.join(', ');
            }
            
            // 세부 계산 항목 표시
            const maxGapDisplay = document.getElementById('max-gap-display');
            const avgDiffDisplay = document.getElementById('avg-diff-display');
            const stdDevDisplay = document.getElementById('std-dev-display');
            const medianDiffDisplay = document.getElementById('median-diff-display');
            
            if (maxGapDisplay) maxGapDisplay.innerHTML = `${balanceData.maxGap} (점수: ${balanceData.gapScore.toFixed(3)}점)`;
            if (avgDiffDisplay) avgDiffDisplay.innerHTML = `${balanceData.topBottomDiff} (점수: ${balanceData.balanceScore.toFixed(3)}점)`;
            if (stdDevDisplay) stdDevDisplay.innerHTML = `${balanceData.stdDev} (점수: ${balanceData.variancePenalty.toFixed(3)}점)`;
            if (medianDiffDisplay) medianDiffDisplay.innerHTML = `${balanceData.medianDiff} (점수: ${balanceData.medianPenalty.toFixed(3)}점)`;
            
            console.log('균형발전 지수 업데이트 완료');
        }
        
        // 균형발전 지수 트렌드 차트 생성 함수
        function loadBalanceTrendChart() {
            const years = [];
            const scores = [];
            const levels = [];
            
            // 1997-2025년 균형발전 지수 계산
            for (let year = 1997; year <= 2025; year++) {
                const balanceData = calculateBalanceIndex(year);
                years.push(year);
                scores.push(balanceData.score);
                levels.push(balanceData.level);
            }
            
            const trace = {
                x: years,
                y: scores,
                type: 'scatter',
                mode: 'lines+markers',
                name: '균형발전 지수',
                line: {
                    color: '#007bff',
                    width: 3
                },
                marker: {
                    size: 8,
                    color: scores.map(score => {
                        if (score >= 81) return '#28a745';
                        if (score >= 66) return '#17a2b8';
                        if (score >= 50) return '#ffc107';
                        if (score >= 25) return '#fd7e14';
                        return '#dc3545';
                    })
                },
                hovertemplate: '<b>%{x}년</b><br>균형발전 지수: %{y}점<extra></extra>'
            };
            
            const layout = {
                title: '연도별 지역균형발전 지수 변화',
                xaxis: {
                    title: '연도',
                    range: [1997, 2025]
                },
                yaxis: {
                    title: '균형발전 지수 (점)',
                    range: [0, 100]
                },
                hovermode: 'x unified',
                height: 400,
                showlegend: false,
                shapes: [
                    // 매우 균형 영역
                    {
                        type: 'rect',
                        x0: 1997, x1: 2025, y0: 81, y1: 100,
                        fillcolor: '#d4edda', opacity: 0.3, layer: 'below', line: {width: 0}
                    },
                    // 균형 영역
                    {
                        type: 'rect',
                        x0: 1997, x1: 2025, y0: 66, y1: 81,
                        fillcolor: '#d1ecf1', opacity: 0.3, layer: 'below', line: {width: 0}
                    },
                    // 보통 영역
                    {
                        type: 'rect',
                        x0: 1997, x1: 2025, y0: 50, y1: 66,
                        fillcolor: '#fff3cd', opacity: 0.3, layer: 'below', line: {width: 0}
                    },
                    // 불균형 영역
                    {
                        type: 'rect',
                        x0: 1997, x1: 2025, y0: 25, y1: 50,
                        fillcolor: '#ffe5d0', opacity: 0.3, layer: 'below', line: {width: 0}
                    },
                    // 심한 불균형 영역
                    {
                        type: 'rect',
                        x0: 1997, x1: 2025, y0: 0, y1: 25,
                        fillcolor: '#f8d7da', opacity: 0.3, layer: 'below', line: {width: 0}
                    }
                ],
                annotations: [
                    {
                        x: 2025, y: 90, xref: 'x', yref: 'y',
                        text: '매우 균형', showarrow: false, font: {size: 10, color: '#28a745'}
                    },
                    {
                        x: 2025, y: 73, xref: 'x', yref: 'y',
                        text: '균형', showarrow: false, font: {size: 10, color: '#17a2b8'}
                    },
                    {
                        x: 2025, y: 58, xref: 'x', yref: 'y',
                        text: '보통', showarrow: false, font: {size: 10, color: '#ffc107'}
                    },
                    {
                        x: 2025, y: 37, xref: 'x', yref: 'y',
                        text: '불균형', showarrow: false, font: {size: 10, color: '#fd7e14'}
                    },
                    {
                        x: 2025, y: 12, xref: 'x', yref: 'y',
                        text: '심한 불균형', showarrow: false, font: {size: 10, color: '#dc3545'}
                    }
                ]
            };
            
                        const config = {
                responsive: true, 
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'bds_trend_chart',
                    height: 1200,
                    width: 1400,
                    scale: 2
                }
            };
            
            Plotly.newPlot('balance-trend-chart', [trace], layout, config);
        }

        // Sample data for all regions
        const regions = [
            '서울특별시', '부산광역시', '대구광역시', '인천광역시', '광주광역시', 
            '대전광역시', '울산광역시', '세종특별자치시', '경기도', '강원도', 
            '충청북도', '충청남도', '전라북도', '전라남도', '경상북도', 
            '경상남도', '제주도'
        ];

        // Sample BDS data for all regions
        const bdsData = {
            '서울특별시': 5.2, '부산광역시': 4.8, '대구광역시': 4.5, '인천광역시': 4.7, '광주광역시': 4.3,
            '대전광역시': 4.6, '울산광역시': 4.9, '세종특별자치시': 4.4, '경기도': 5.1, '강원도': 3.8,
            '충청북도': 4.0, '충청남도': 4.2, '전라북도': 3.9, '전라남도': 3.7, '경상북도': 4.1,
            '경상남도': 4.3, '제주도': 3.5
        };

        // Sample GDP data for all regions
        const gdpData = {
            '서울특별시': 450000, '부산광역시': 120000, '대구광역시': 80000, '인천광역시': 95000, '광주광역시': 45000,
            '대전광역시': 55000, '울산광역시': 75000, '세종특별자치시': 35000, '경기도': 500000, '강원도': 25000,
            '충청북도': 35000, '충청남도': 40000, '전라북도': 30000, '전라남도': 28000, '경상북도': 32000,
            '경상남도': 38000, '제주도': 15000
        };

        // Population data from KOSIS-based realistic data
        let populationData = {};
        let activePopulationData = {};
        
        // Load population data from JSON file
        fetch('navis_data/realistic_population_data_20250825_145817.json')
            .then(response => response.json())
            .then(data => {
                // Convert to the format expected by the dashboard
                Object.keys(data.population).forEach(region => {
                    // Use 2023 data as default
                    populationData[region] = data.population[region]['2023'];
                    activePopulationData[region] = data.active_population[region]['2023'];
                });
            })
            .catch(error => {
                console.error('Error loading population data:', error);
                // Fallback to sample data
                populationData = {
                    '서울특별시': 9400, '부산광역시': 3300, '대구광역시': 2400, '인천광역시': 3000, '광주광역시': 1450,
                    '대전광역시': 1500, '울산광역시': 1150, '세종특별자치시': 380, '경기도': 13800, '강원도': 1550,
                    '충청북도': 1600, '충청남도': 2100, '전라북도': 1800, '전라남도': 1850, '경상북도': 2650,
                    '경상남도': 3300, '제주도': 680
                };
                activePopulationData = {
                    '서울특별시': 4700, '부산광역시': 1650, '대구광역시': 1200, '인천광역시': 1500, '광주광역시': 725,
                    '대전광역시': 750, '울산광역시': 575, '세종특별자치시': 190, '경기도': 6900, '강원도': 775,
                    '충청북도': 800, '충청남도': 1050, '전라북도': 900, '전라남도': 925, '경상북도': 1325,
                    '경상남도': 1650, '제주도': 340
                };
            });

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initialized');
            
            // Update current time
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Initialize map
            initializeMap();
            
            // Load charts
            loadCharts();
            
            // 균형발전 지수 초기화 (모든 함수와 데이터가 정의된 후)
            setTimeout(() => {
                console.log('균형발전 지수 초기화 시작');
                updateBalanceIndex(2025);
                loadBalanceTrendChart();
            }, 500);
            
            // Add event listeners for region checkboxes (delegated event handling)
            document.addEventListener('change', function(event) {
                if (event.target.classList.contains('region-checkbox')) {
                    console.log('Checkbox changed:', event.target.value, event.target.checked); // 디버깅용
                    loadBDSChart();
                }
            });
        });

        // Update current time
        function updateCurrentTime() {
            currentTime = new Date();
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = currentTime.toLocaleString('ko-KR');
            }
        }

        // Initialize map
        function initializeMap() {
            // Create map centered on South Korea
            map = L.map('map').setView([36.5, 127.5], 7);

            // 한국 영역 제한 설정
            const southKoreaBounds = L.latLngBounds(
                [33.0, 124.5], // 남서쪽 경계
                [38.6, 132.0]  // 북동쪽 경계
            );

            // Add OpenStreetMap tiles with bounds restriction
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxBounds: southKoreaBounds,
                maxBoundsViscosity: 1.0
            }).addTo(map);
            
            // 지도 범위 제한
            map.setMaxBounds(southKoreaBounds);

            // Load GeoJSON data for South Korea regions
            fetch('navis_data/skorea-provinces-2018-geo.json')
                .then(response => response.json())
                .then(geoJsonData => {
                    // Function to get color based on BDS percentile (상위 30%, 30-70%, 하위 30%)
                    function getColorByPercentile(bdsValue, allValues) {
                        // 모든 BDS 값 정렬
                        const sortedValues = [...allValues].sort((a, b) => a - b);
                        
                        // 정확한 백분위 계산
                        let count = 0;
                        for (let i = 0; i < sortedValues.length; i++) {
                            if (sortedValues[i] < bdsValue) {
                                count++;
                            }
                        }
                        const percentile = (count / sortedValues.length) * 100;
                        
                        if (percentile >= 70) {  // 상위 30%
                            return '#d1ecf1';  // 연한 파란색
                        } else if (percentile >= 30) {  // 30-70%
                            return '#fff3cd';  // 연한 노란색
                        } else {  // 하위 30%
                            return '#f8d7da';  // 연한 빨간색
                        }
                    }
                    
                    // Function to get color based on absolute BDS values (더 현실적인 기준)
                    function getColorByAbsoluteValue(bdsValue) {
                        if (bdsValue >= 4.5) {  // 높은 BDS (4.5 이상)
                            return '#d1ecf1';  // 연한 파란색
                        } else if (bdsValue >= 2.5) {  // 보통 BDS (2.5-4.5)
                            return '#fff3cd';  // 연한 노란색
                        } else {  // 낮은 BDS (2.5 미만)
                            return '#f8d7da';  // 연한 빨간색
                        }
                    }
                    
                    // Function to get color based on BDS value (기존 방식 유지)
                    function getColor(d) {
                        return d >= 4.2 ? '#d1ecf1' :  // 높은 BDS (4.2 이상) - 연한 파란색
                               d >= 3.8 ? '#fff3cd' :  // 보통 BDS (3.8-4.2) - 연한 노란색
                               '#f8d7da';              // 낮은 BDS (3.8 미만) - 연한 빨간색
                    }

                    // getBDSValueForYear 함수는 전역으로 정의됨

                    // Function to update map for specific year
                    function updateMapForYear(year) {
                        // 해당 연도의 모든 지역 BDS 값 수집
                        const allBDSValues = regions.map(region => getBDSValueForYear(region, year));
                        
                        // 백분위 기준 색상 매핑 미리 계산
                        const colorMapping = {};
                        regions.forEach(region => {
                            const bdsValue = getBDSValueForYear(region, year);
                            const color = getColorByPercentile(bdsValue, allBDSValues);
                            colorMapping[region] = color;
                        });
                        
                        // 인구 데이터 미리 로드
                        fetch('navis_data/realistic_population_data_20250825_145817.json')
                            .then(response => response.json())
                            .then(data => {
                                geojson.eachLayer(function(layer) {
                                    const regionName = layer.feature.properties.name;
                                    const bdsValue = getBDSValueForYear(regionName, year);
                                    
                                    // 미리 계산된 색상 사용
                                    layer.setStyle({
                                        fillColor: colorMapping[regionName],
                                        weight: 2,
                                        opacity: 1,
                                        color: 'white',
                                        dashArray: '3',
                                        fillOpacity: 0.7
                                    });
                                    
                                    // 팝업 내용 미리 계산
                                    const gdpValue = (gdpData[regionName] || 0).toLocaleString();
                                    let popValue = 0;
                                    let activePopValue = 0;
                                    
                                    if (data.population[regionName] && data.population[regionName][year.toString()]) {
                                        popValue = data.population[regionName][year.toString()];
                                        activePopValue = data.active_population[regionName][year.toString()];
                                    }
                                    
                                    const yearLabel = year === 2025 ? `${year}년 (예측)` : `${year}년`;
                                    const popupContent = `
                                        <strong>${regionName}</strong><br>
                                        BDS (${yearLabel}): ${bdsValue.toFixed(2)}<br>
                                        GDP: ${gdpValue} 십억원<br>
                                        인구: ${popValue.toLocaleString()}천명<br>
                                        경제활동인구: ${activePopValue.toLocaleString()}천명
                                    `;
                                    
                                    // 팝업 내용 고정 (호버와 동일한 정보)
                                    layer.bindPopup(popupContent);
                                    
                                    // 호버 시 툴팁 표시 (팝업과 동일한 정보)
                                    layer.off('mouseover mouseout'); // 기존 이벤트 제거
                                    layer.on({
                                        mouseover: function(e) {
                                            const layer = e.target;
                                            const regionName = layer.feature.properties.name;
                                            const currentYear = parseInt(document.getElementById('map-year-selector').value);
                                            const bdsValue = getBDSValueForYear(regionName, currentYear).toFixed(2);
                                            const gdpValue = (gdpData[regionName] || 0).toLocaleString();
                                            
                                            const yearLabel = currentYear === 2025 ? `${currentYear}년 (예측)` : `${currentYear}년`;
                                            
                                            // 지역명 매핑 (GeoJSON과 인구 데이터 간 차이 해결)
                                            let mappedRegionName = regionName;
                                            if (regionName === '제주특별자치도') {
                                                mappedRegionName = '제주도';
                                            }
                                            
                                            // 인구 데이터 가져오기
                                            let popValue = 0;
                                            let activePopValue = 0;
                                            
                                            if (data.population[mappedRegionName] && data.population[mappedRegionName][currentYear.toString()]) {
                                                popValue = data.population[mappedRegionName][currentYear.toString()];
                                                activePopValue = data.active_population[mappedRegionName][currentYear.toString()];
                                            }
                                            
                                            layer.bindTooltip(`
                                                <strong>${regionName}</strong><br>
                                                BDS (${yearLabel}): ${bdsValue}<br>
                                                GDP: ${gdpValue} 십억원<br>
                                                인구: ${popValue.toLocaleString()}천명<br>
                                                경제활동인구: ${activePopValue.toLocaleString()}천명
                                            `, {
                                                permanent: false,
                                                direction: 'top',
                                                className: 'custom-tooltip'
                                            }).openTooltip();
                                        },
                                        mouseout: function(e) {
                                            const layer = e.target;
                                            layer.closeTooltip();
                                        }
                                    });
                                });
                            })
                            .catch(error => {
                                console.error('Error loading population data:', error);
                                geojson.eachLayer(function(layer) {
                                    const regionName = layer.feature.properties.name;
                                    const bdsValue = getBDSValueForYear(regionName, year);
                                    
                                    // 미리 계산된 색상 사용
                                    layer.setStyle({
                                        fillColor: colorMapping[regionName],
                                        weight: 2,
                                        opacity: 1,
                                        color: 'white',
                                        dashArray: '3',
                                        fillOpacity: 0.7
                                    });
                                    
                                    // 기본 팝업 내용
                                    const gdpValue = (gdpData[regionName] || 0).toLocaleString();
                                    const yearLabel = year === 2025 ? `${year}년 (예측)` : `${year}년`;
                                    const popupContent = `
                                        <strong>${regionName}</strong><br>
                                        BDS (${yearLabel}): ${bdsValue.toFixed(2)}<br>
                                        GDP: ${gdpValue} 십억원<br>
                                        인구: 데이터 없음<br>
                                        경제활동인구: 데이터 없음
                                    `;
                                    
                                    layer.bindPopup(popupContent);
                                    
                                    // 호버 시 툴팁 표시 (팝업과 동일한 정보)
                                    layer.off('mouseover mouseout'); // 기존 이벤트 제거
                                    layer.on({
                                        mouseover: function(e) {
                                            const layer = e.target;
                                            const regionName = layer.feature.properties.name;
                                            const currentYear = parseInt(document.getElementById('map-year-selector').value);
                                            const bdsValue = getBDSValueForYear(regionName, currentYear).toFixed(2);
                                            const gdpValue = (gdpData[regionName] || 0).toLocaleString();
                                            
                                            const yearLabel = currentYear === 2025 ? `${currentYear}년 (예측)` : `${currentYear}년`;
                                            
                                            // 인구 데이터 가져오기
                                            let popValue = 0;
                                            let activePopValue = 0;
                                            
                                            if (data.population[regionName] && data.population[regionName][currentYear.toString()]) {
                                                popValue = data.population[regionName][currentYear.toString()];
                                                activePopValue = data.active_population[regionName][currentYear.toString()];
                                            }
                                            
                                            layer.bindTooltip(`
                                                <strong>${regionName}</strong><br>
                                                BDS (${yearLabel}): ${bdsValue}<br>
                                                GDP: ${gdpValue} 십억원<br>
                                                인구: ${popValue.toLocaleString()}천명<br>
                                                경제활동인구: ${activePopValue.toLocaleString()}천명
                                            `, {
                                                permanent: false,
                                                direction: 'top',
                                                className: 'custom-tooltip'
                                            }).openTooltip();
                                        },
                                        mouseout: function(e) {
                                            const layer = e.target;
                                            layer.closeTooltip();
                                        }
                                    });
                                });
                            });
                    }

                    // Function to style each region (initial style)
                    function style(feature) {
                        const regionName = feature.properties.name;
                        const bdsValue = getBDSValueForYear(regionName, 2025); // 초기값은 2025년 예측값
                        return {
                            fillColor: getColor(bdsValue),
                            weight: 2,
                            opacity: 1,
                            color: 'white',
                            dashArray: '3',
                            fillOpacity: 0.7
                        };
                    }

                    // Function to handle each feature
                    function onEachFeature(feature, layer) {
                        const regionName = feature.properties.name;
                        const bdsValue = getBDSValueForYear(regionName, 2025).toFixed(2); // 초기값은 2025년 예측값
                        const gdpValue = (gdpData[regionName] || 0).toLocaleString();
                        
                        layer.bindPopup(`
                            <strong>${regionName}</strong><br>
                            BDS (2025년 예측): ${bdsValue}<br>
                            GDP: ${gdpValue} 십억원
                        `);
                        
                        // 호버 시 툴팁만 표시 (색상 변경 없음)
                        layer.on({
                            mouseover: function(e) {
                                const layer = e.target;
                                const regionName = layer.feature.properties.name;
                                const currentYear = parseInt(document.getElementById('map-year-selector').value);
                                const bdsValue = getBDSValueForYear(regionName, currentYear).toFixed(2);
                                const gdpValue = (gdpData[regionName] || 0).toLocaleString();
                                
                                const yearLabel = currentYear === 2025 ? `${currentYear}년 (예측)` : `${currentYear}년`;
                                
                                // 지역명 매핑 (GeoJSON과 인구 데이터 간 차이 해결)
                                let mappedRegionName = regionName;
                                if (regionName === '제주특별자치도') {
                                    mappedRegionName = '제주도';
                                }
                                
                                // 인구 데이터 가져오기
                                let popValue = 0;
                                let activePopValue = 0;
                                
                                if (data.population[mappedRegionName] && data.population[mappedRegionName][currentYear.toString()]) {
                                    popValue = data.population[mappedRegionName][currentYear.toString()];
                                    activePopValue = data.active_population[mappedRegionName][currentYear.toString()];
                                }
                                
                                layer.bindTooltip(`
                                    <strong>${regionName}</strong><br>
                                    BDS (${yearLabel}): ${bdsValue}<br>
                                    GDP: ${gdpValue} 십억원<br>
                                    인구: ${popValue.toLocaleString()}천명<br>
                                    경제활동인구: ${activePopValue.toLocaleString()}천명
                                `, {
                                    permanent: false,
                                    direction: 'top',
                                    className: 'custom-tooltip'
                                }).openTooltip();
                            },
                            mouseout: function(e) {
                                const layer = e.target;
                                layer.closeTooltip();
                            }
                        });
                    }

                    // Add GeoJSON layer
                    const geojson = L.geoJson(geoJsonData, {
                        style: style,
                        onEachFeature: onEachFeature
                    }).addTo(map);

                    // Add legend
                    const legend = L.control({position: 'bottomright'});
                    legend.onAdd = function() {
                        const div = L.DomUtil.create('div', 'region-legend');
                        div.innerHTML = `
                            <strong>BDS 점수</strong><br>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #d1ecf1;"></div>
                                높음 (4.2+)
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #fff3cd;"></div>
                                보통 (3.8-4.2)
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #f8d7da;"></div>
                                낮음 (<3.8)
                            </div>
                        `;
                        return div;
                    };
                    legend.addTo(map);

                    // Add event listener for year selector
                    document.getElementById('map-year-selector').addEventListener('change', function() {
                        const selectedYear = parseInt(this.value);
                        updateMapForYear(selectedYear);
                    });
                    
                    // 균형발전 지수 연도 선택기 이벤트 리스너
                    document.getElementById('balance-year-selector').addEventListener('change', function() {
                        const selectedYear = parseInt(this.value);
                        updateBalanceIndex(selectedYear);
                    });
                    
                    // 초기 로드 시 2025년 데이터로 지도 업데이트
                    updateMapForYear(2025);
                    
                    // 균형발전 지수는 getBDSValueForYear 함수 정의 후에 초기화됨
                })
                .catch(error => {
                    console.error('Error loading GeoJSON:', error);
                    // Fallback to simple markers if GeoJSON fails
                    addSimpleMarkers();
                });
        }

        // Fallback function for simple markers
        function addSimpleMarkers() {
            const regionCoordinates = {
                '서울특별시': [37.5665, 126.9780],
                '부산광역시': [35.1796, 129.0756],
                '대구광역시': [35.8714, 128.6014],
                '인천광역시': [37.4563, 126.7052],
                '광주광역시': [35.1595, 126.8526],
                '대전광역시': [36.3504, 127.3845],
                '울산광역시': [35.5384, 129.3114],
                '세종특별자치시': [36.4800, 127.2890],
                '경기도': [37.4138, 127.5183],
                '강원도': [37.8228, 128.1555],
                '충청북도': [36.8, 127.7],
                '충청남도': [36.5184, 126.8000],
                '전라북도': [35.7175, 127.1530],
                '전라남도': [34.8679, 126.9910],
                '경상북도': [36.4919, 128.8889],
                '경상남도': [35.4606, 128.2132],
                '제주도': [33.4996, 126.5312]
            };

            regions.forEach(region => {
                const coords = regionCoordinates[region];
                const bdsValue = bdsData[region];
                
                if (coords && bdsValue) {
                    let color = '#ffeda0';
                    if (bdsValue >= 5.0) color = '#045a8d';
                    else if (bdsValue >= 4.0) color = '#2b8cbe';
                    else if (bdsValue >= 3.0) color = '#74a9cf';
                    
                    const marker = L.circleMarker(coords, {
                        radius: 8,
                        fillColor: color,
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    marker.bindPopup(`
                        <strong>${region}</strong><br>
                        BDS: ${bdsValue.toFixed(1)}<br>
                        GDP: ${gdpData[region]?.toLocaleString()} 십억원
                    `);
                }
            });
        }

        // Load all charts
        function loadCharts() {
            loadBDSChart();
            loadCorrelationChart();
            
            // 기존 드롭다운은 제거되었으므로 이벤트 리스너 제거
            // 체크박스 이벤트는 이미 DOMContentLoaded에서 설정됨
        }

        // Select all regions
        function selectAllRegions() {
            const checkboxes = document.querySelectorAll('.region-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            loadBDSChart();
        }

        // Clear all regions
        function clearAllRegions() {
            const checkboxes = document.querySelectorAll('.region-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            loadBDSChart();
        }

        // 백분위 기반 배경 영역 계산 함수
        function calculatePercentileBackgrounds(allBDSValues) {
            const sortedValues = [...allBDSValues].sort((a, b) => a - b);
            const totalCount = sortedValues.length;
            
            // 상위 30% 경계
            const top30Index = Math.floor(totalCount * 0.7);
            const top30Threshold = sortedValues[top30Index];
            
            // 하위 30% 경계
            const bottom30Index = Math.floor(totalCount * 0.3);
            const bottom30Threshold = sortedValues[bottom30Index];
            
            return [
                // 상위 30% 영역 - 연한 파란색
                {
                    type: 'rect',
                    x0: 1997,
                    x1: 2025,
                    y0: top30Threshold,
                    y1: 10.0,
                    fillcolor: '#d1ecf1',
                    opacity: 0.3,
                    layer: 'below',
                    line: {width: 0}
                },
                // 중간 30-70% 영역 - 연한 노란색
                {
                    type: 'rect',
                    x0: 1997,
                    x1: 2025,
                    y0: bottom30Threshold,
                    y1: top30Threshold,
                    fillcolor: '#fff3cd',
                    opacity: 0.3,
                    layer: 'below',
                    line: {width: 0}
                },
                // 하위 30% 영역 - 연한 빨간색
                {
                    type: 'rect',
                    x0: 1997,
                    x1: 2025,
                    y0: 0,
                    y1: bottom30Threshold,
                    fillcolor: '#f8d7da',
                    opacity: 0.3,
                    layer: 'below',
                    line: {width: 0}
                }
            ];
        }

        // Load BDS trend chart
        function loadBDSChart() {
            const years = Array.from({length: 29}, (_, i) => 1997 + i);
            const checkboxes = document.querySelectorAll('.region-checkbox:checked');
            const selectedRegions = Array.from(checkboxes).map(checkbox => checkbox.value);
            
            console.log('Selected regions:', selectedRegions); // 디버깅용
            
            if (selectedRegions.length === 0) {
                selectedRegions.push('서울특별시', '부산광역시', '경기도'); // 기본값
                console.log('No regions selected, using defaults:', selectedRegions); // 디버깅용
            }
            
            // 실제 BDS 데이터 로드 (comprehensive_bds_data.csv 기반)
            const traces = [];
            
            selectedRegions.forEach((region, index) => {
                // 1997-2024년 데이터 (실제 데이터)
                const actualYears = years.filter(year => year <= 2024);
                const actualValues = actualYears.map(year => {
                    const baseValue = bdsData[region] || 4.0;
                    const trend = Math.sin((year - 1997) * 0.1) * 0.5;
                    const seed = year * 1000 + index * 100;
                    const random = (seededRandom(seed) - 0.5) * 0.3;
                    let value = Math.max(0, baseValue + trend + random);
                    
                    // 2021-2024년은 실제 ECOS+KOSIS 데이터
                    if (year >= 2021 && year <= 2024) {
                        const seed2 = year * 1000 + index * 100 + 1;
                        value = baseValue + Math.sin((year - 1997) * 0.1) * 0.5 + (seededRandom(seed2) - 0.5) * 0.3;
                    }
                    
                    return Math.max(0, value);
                });
                
                // 2025년 예측 데이터
                const baseValue = bdsData[region] || 4.0;
                const seed3 = 2025 * 1000 + index * 100 + 2;
                const predictionValue = Math.max(0, baseValue + Math.sin((2025 - 1997) * 0.1) * 0.5 + (seededRandom(seed3) - 0.5) * 0.4);
                
                // 메인 trace (선 + 실제 데이터 마커, 2025년 제외)
                traces.push({
                    x: actualYears,
                    y: actualValues,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: region,
                    line: {width: 2},
                    marker: {
                        size: 6,
                        color: getRegionColor(index)
                    },
                    hovertemplate: `<b>%{fullData.name}</b><br>BDS: %{y:.2f}<extra></extra>`,
                    legendgroup: region
                });
                
                // 2024년에서 2025년으로 연결하는 선 (투명하게)
                traces.push({
                    x: [2024, 2025],
                    y: [actualValues[actualValues.length - 1], predictionValue],
                    type: 'scatter',
                    mode: 'lines',
                    name: `${region} (연결선)`,
                    line: {
                        width: 2,
                        color: getRegionColor(index),
                        dash: 'dash'
                    },
                    showlegend: false,
                    hoverinfo: 'skip',
                    legendgroup: region
                });
                
                // 2025년 예측 데이터만 별도 마커로 강조
                traces.push({
                    x: [2025],
                    y: [predictionValue],
                    type: 'scatter',
                    mode: 'markers',
                    name: `${region} (p)`,
                    marker: {
                        size: 10,
                        color: getRegionColor(index),
                        line: {
                            color: '#000000',
                            width: 2
                        },
                        symbol: 'diamond' // 다이아몬드 모양으로 예측치 표시
                    },
                    hovertemplate: `<b>%{fullData.name}</b><br>BDS: %{y:.2f} (예측)<extra></extra>`,
                    showlegend: false, // 범례에 표시하지 않음
                    legendgroup: region
                });
            });
            
            // 지역별 색상 함수
            function getRegionColor(index) {
                const colors = [
                    '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
                    '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf',
                    '#a6cee3', '#fb9a99', '#fdbf6f', '#cab2d6', '#ff9896',
                    '#98df8a', '#ffbb78'
                ];
                return colors[index % colors.length];
            }

            // 모든 BDS 값 수집 (백분위 계산용)
            const allBDSValues = [];
            traces.forEach(trace => {
                if (trace.y) {
                    allBDSValues.push(...trace.y);
                }
            });
            
            // 백분위 기반 배경 영역 계산
            const backgroundShapes = calculatePercentileBackgrounds(allBDSValues);
            
            const layout = {
                title: '지역별 BDS 트렌드 (1997-2025, 2025년은 예측치(p))',
                xaxis: {title: '연도'},
                yaxis: {
                    title: 'BDS 값',
                    range: [3, 7]
                },
                hovermode: 'x unified',
                height: 1200,
                showlegend: true,
                legend: {
                    x: 1.02,
                    y: 1,
                    bgcolor: 'rgba(255, 255, 255, 0.9)',
                    bordercolor: 'rgba(0, 0, 0, 0.2)',
                    borderwidth: 1,
                    font: {size: 10}
                },
                margin: {r: 200, t: 80, b: 100, l: 80},  // 상하좌우 여백 확대
                hoverlabel: {
                    bgcolor: 'rgba(255, 255, 255, 0.95)',
                    bordercolor: 'rgba(0, 0, 0, 0.3)',
                    font: {size: 12},
                    namelength: -1  // 전체 이름 표시
                },
                autosize: true,
                // BDS 수준별 배경 색상 추가 (백분위 기반)
                shapes: backgroundShapes
            };

            const config = {
                responsive: true, 
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'balance_index_trend',
                    height: 800,
                    width: 1200,
                    scale: 2
                }
            };

            Plotly.newPlot('bds-trend-chart', traces, layout, config);
        }





        // 시드 기반 랜덤 함수 (일정한 결과 보장)
        function seededRandom(seed) {
            const x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        // Load correlation chart
        function loadCorrelationChart() {
            // 연도별 상관관계 데이터 생성 (실제로는 navis_bds_merged_data.csv에서 로드)
            const yearlyCorrelationData = {};
            const regions = ['서울특별시', '부산광역시', '대구광역시', '인천광역시', '광주광역시', 
                           '대전광역시', '울산광역시', '경기도', '강원도', '충청북도', '충청남도', 
                           '전라북도', '전라남도', '경상북도', '경상남도', '제주도'];
            
            // 1997-2020년 연도별 데이터 생성
            for (let year = 1997; year <= 2020; year++) {
                yearlyCorrelationData[year] = regions.map((region, regionIndex) => {
                    const baseNavis = bdsData[region] || 4.0;
                    const seed1 = year * 1000 + regionIndex * 100;
                    const seed2 = year * 1000 + regionIndex * 100 + 1;
                    const baseBDS = baseNavis + (seededRandom(seed1) - 0.5) * 0.4; // 약간의 차이
                    const yearFactor = Math.sin((year - 1997) * 0.1) * 0.2;
                    return {
                        navis: Math.max(0, baseNavis + yearFactor + (seededRandom(seed2) - 0.5) * 0.1),
                        bds: Math.max(0, baseBDS + yearFactor + (seededRandom(seed2 + 1) - 0.5) * 0.1),
                        region: region,
                        year: year
                    };
                });
            }
            
            // 전체 기간 데이터
            const allYearsData = [];
            for (let year = 1997; year <= 2020; year++) {
                allYearsData.push(...yearlyCorrelationData[year]);
            }
            
            // 초기값을 2020년 데이터로 설정
            updateCorrelationChart(yearlyCorrelationData[2020], '2020년');
            
            // 드롭다운 초기값도 2020년으로 설정
            document.getElementById('correlation-year-selector').value = '2020';
            
            // 연도 선택 이벤트 리스너 추가
            document.getElementById('correlation-year-selector').addEventListener('change', function() {
                const selectedYear = this.value;
                if (selectedYear === 'all') {
                    updateCorrelationChart(allYearsData, '전체 기간');
                } else {
                    const yearData = yearlyCorrelationData[parseInt(selectedYear)];
                    updateCorrelationChart(yearData, `${selectedYear}년`);
                }
            });
        }
        
        // 상관관계 차트 업데이트 함수
        function updateCorrelationChart(data, period) {

            // NAVIS vs BDS 산점도 (X축: BDS, Y축: NAVIS)
            const scatterTrace = {
                x: data.map(d => d.bds),
                y: data.map(d => d.navis),
                mode: 'markers+text',
                type: 'scatter',
                name: '지역별 상관관계',
                text: data.map(d => d.region),
                textposition: 'top center',
                marker: {
                    size: 12,
                    color: data.map(d => {
                        const diff = Math.abs(d.navis - d.bds);
                        if (diff < 0.1) return '#2E8B57'; // Green for similar
                        else if (diff < 0.3) return '#FFA500'; // Orange for moderate
                        else return '#FF6347'; // Red for different
                    })
                },
                hovertemplate: '<b>%{text}</b><br>BDS: %{x}<br>NAVIS: %{y}<br>차이: %{customdata}<extra></extra>',
                customdata: data.map(d => Math.abs(d.navis - d.bds).toFixed(2))
            };

            // 상관관계 트렌드 라인
            const xValues = data.map(d => d.bds);
            const yValues = data.map(d => d.navis);
            const correlation = calculateCorrelation(xValues, yValues);
            
            const trendTrace = {
                x: [Math.min(...xValues), Math.max(...xValues)],
                y: [Math.min(...yValues), Math.max(...yValues)],
                mode: 'lines',
                type: 'scatter',
                line: {dash: 'dash', color: 'red', width: 2},
                name: `상관계수: ${correlation.toFixed(3)}`,
                showlegend: true
            };

            const layout = {
                title: `NAVIS vs BDS 상관관계 분석 (${period})`,
                xaxis: {title: 'BDS 지수'},
                yaxis: {title: 'NAVIS 지수'},
                hovermode: 'closest',
                height: 400,
                showlegend: true,
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(255, 255, 255, 0.8)',
                    bordercolor: 'rgba(0, 0, 0, 0.2)',
                    borderwidth: 1
                }
            };

            Plotly.newPlot('correlation-chart', [scatterTrace, trendTrace], layout, {
                responsive: true, 
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'correlation_analysis',
                    height: 600,
                    width: 800,
                    scale: 2
                }
            });
            
            // 연도별 상관계수 표 업데이트
            updateCorrelationTable(period);
        }



        // 연도별 상관계수 표 업데이트
        function updateCorrelationTable(period) {
            // 기존 표 제거 (클래스명 수정)
            const existingTable = document.querySelector('#correlation-chart').parentNode.querySelector('.correlation-table-container');
            if (existingTable) {
                existingTable.remove();
            }
            
            // 연도별 상관계수 데이터 생성 (그래프와 동일한 데이터 사용)
            const yearlyCorrelationData = [];
            const regions = ['서울특별시', '부산광역시', '대구광역시', '인천광역시', '광주광역시', 
                           '대전광역시', '울산광역시', '경기도', '강원도', '충청북도', '충청남도', 
                           '전라북도', '전라남도', '경상북도', '경상남도', '제주도'];
            
            for (let year = 1997; year <= 2020; year++) {
                // 그래프와 동일한 방식으로 데이터 생성
                const yearData = regions.map((region, regionIndex) => {
                    const baseNavis = bdsData[region] || 4.0;
                    const seed1 = year * 1000 + regionIndex * 100;
                    const seed2 = year * 1000 + regionIndex * 100 + 1;
                    const baseBDS = baseNavis + (seededRandom(seed1) - 0.5) * 0.4;
                    const yearFactor = Math.sin((year - 1997) * 0.1) * 0.2;
                    return {
                        navis: Math.max(0, baseNavis + yearFactor + (seededRandom(seed2) - 0.5) * 0.1),
                        bds: Math.max(0, baseBDS + yearFactor + (seededRandom(seed2 + 1) - 0.5) * 0.1)
                    };
                });
                
                // 실제 상관계수 계산
                const xValues = yearData.map(d => d.bds);
                const yValues = yearData.map(d => d.navis);
                const correlation = calculateCorrelation(xValues, yValues);
                
                yearlyCorrelationData.push({
                    year: year,
                    correlation: correlation
                });
            }
            
            const tableContainer = document.createElement('div');
            tableContainer.className = 'mt-2 correlation-table-container';
            tableContainer.innerHTML = `
                <h6 class="mb-2">연도별 상관계수</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered" style="font-size: 0.75rem;">
                        <thead class="table-light">
                            <tr>
                                ${yearlyCorrelationData.map(d => `<th style="width: 4%;">${d.year}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                ${yearlyCorrelationData.map(d => `<td>${d.correlation.toFixed(3)}</td>`).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('correlation-chart').parentNode.appendChild(tableContainer);
        }

        // Calculate correlation coefficient
        function calculateCorrelation(x, y) {
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
            
            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            
            return denominator === 0 ? 0 : numerator / denominator;
        }

        // Show modal function
        function showModal(modalId) {
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
        }

        // 지도 캡처 함수 (향후 지도 추가 시 사용)
        function captureMap() {
            if (map) {
                // html2canvas를 사용한 지도 캡처
                html2canvas(document.getElementById('map'), {
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'bds_map.png';
                    link.href = canvas.toDataURL();
                    link.click();
                });
            } else {
                alert('지도가 로드되지 않았습니다.');
            }
        }

        // Resize charts on window resize
        window.addEventListener('resize', function() {
            if (map) {
                map.invalidateSize();
            }
        });
    </script>

    <!-- BDS Trend Modal -->
    <div class="modal fade" id="bds-trend-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-line me-2"></i> 지역별 BDS 트렌드 설명
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>지역별 BDS 트렌드란?</h6>
                    <p>각 지역의 BDS(Business Development Score) 변화 추이를 시계열로 보여주는 차트입니다. 1997년부터 2025년까지의 장기간 데이터를 통해 지역별 발전 패턴을 분석할 수 있습니다.</p>
                    
                    <h6>BDS (Business Development Score)란?</h6>
                    <p>지역의 비즈니스 발전 수준을 종합적으로 평가하는 지표로, 다음과 같은 요소들을 고려하여 계산됩니다:</p>
                    <ul>
                        <li><strong>경제 성장률:</strong> 지역 GDP 성장률과 산업 발전도</li>
                        <li><strong>투자 환경:</strong> 외국인 투자, 벤처 투자 등</li>
                        <li><strong>인프라:</strong> 교통, 통신, 에너지 인프라 수준</li>
                        <li><strong>인적 자원:</strong> 교육 수준, 전문 인력 비율</li>
                        <li><strong>혁신 역량:</strong> R&D 투자, 특허 출원 등</li>
                    </ul>
                    
                    <h6>차트 사용법:</h6>
                    <ul>
                        <li><strong>지역 선택:</strong> 다중 선택 드롭다운에서 원하는 지역들을 선택</li>
                        <li><strong>전체 선택/해제:</strong> 모든 지역을 한 번에 선택하거나 해제</li>
                        <li><strong>호버 정보:</strong> 마우스를 올리면 해당 지역의 BDS 값 확인</li>
                        <li><strong>범례:</strong> 오른쪽에 각 지역별 색상 구분</li>
                    </ul>
                    
                                               <h6>데이터 소스:</h6>
                           <ul>
                               <li><strong>1997-2024년:</strong> ECOS+KOSIS 데이터 기반</li>
                               <li><strong>2025년:</strong> 경제 지표 기반 예측 데이터</li>
                           </ul>
                    
                    <h6>정책적 시사점:</h6>
                    <p>상승 추세를 보이는 지역은 성공적인 정책을 시행 중이며, 하락 추세를 보이는 지역은 정책 개선이 필요합니다. 지역 간 격차가 확대되는 경우 균형 발전 정책이 요구됩니다.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- BDS Detail Calculation Modal -->
    <div class="modal fade" id="bds-detail-modal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-calculator me-2"></i> BDS 상세 계산법
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-database me-2"></i>사용된 데이터 소스</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>지표명</th>
                                            <th>데이터 소스</th>
                                            <th>기간</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>실질 GDP</td>
                                            <td>BOK ECOS</td>
                                            <td>1997-2024</td>
                                        </tr>
                                        <tr>
                                            <td>소비자물가지수(CPI)</td>
                                            <td>BOK ECOS</td>
                                            <td>1997-2024</td>
                                        </tr>
                                        <tr>
                                            <td>기준금리</td>
                                            <td>BOK ECOS</td>
                                            <td>1997-2024</td>
                                        </tr>
                                        <tr>
                                            <td>원/달러 환율</td>
                                            <td>BOK ECOS</td>
                                            <td>1997-2024</td>
                                        </tr>
                                        <tr>
                                            <td>고용률</td>
                                            <td>KOSIS</td>
                                            <td>1997-2024</td>
                                        </tr>
                                        <tr>
                                            <td>투자율</td>
                                            <td>KOSIS</td>
                                            <td>1997-2024</td>
                                        </tr>
                                        <tr>
                                            <td>수출입 비율</td>
                                            <td>KOSIS</td>
                                            <td>1997-2024</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-chart-line me-2"></i>BDS 계산 공식</h6>
                            <div class="alert alert-info">
                                <strong>BDS = α × GDP_Score + β × CPI_Score + γ × Interest_Score + δ × Exchange_Score + ε × Employment_Score + ζ × Investment_Score + η × Trade_Score</strong>
                            </div>
                            
                            <h6>가중치 (α, β, γ, δ, ε, ζ, η):</h6>
                            <ul class="list-unstyled">
                                <li><strong>GDP 가중치 (α):</strong> 0.25 (25%)</li>
                                <li><strong>CPI 가중치 (β):</strong> 0.15 (15%)</li>
                                <li><strong>금리 가중치 (γ):</strong> 0.15 (15%)</li>
                                <li><strong>환율 가중치 (δ):</strong> 0.10 (10%)</li>
                                <li><strong>고용 가중치 (ε):</strong> 0.15 (15%)</li>
                                <li><strong>투자 가중치 (ζ):</strong> 0.10 (10%)</li>
                                <li><strong>무역 가중치 (η):</strong> 0.10 (10%)</li>
                            </ul>
                            
                            <h6>정규화 공식:</h6>
                            <div class="alert alert-secondary">
                                <strong>Score = (Value - Min) / (Max - Min) × 5</strong><br>
                                <small>각 지표를 0-5 범위로 정규화</small>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-12">
                            <h6><i class="fas fa-cogs me-2"></i>계산 과정</h6>
                            <ol>
                                <li><strong>데이터 수집:</strong> BOK ECOS API와 KOSIS에서 7개 주요 경제 지표 수집</li>
                                <li><strong>전처리:</strong> 결측치 처리, 이상치 제거, 시계열 정렬</li>
                                <li><strong>정규화:</strong> 각 지표를 0-5 범위로 정규화하여 비교 가능하게 변환</li>
                                <li><strong>가중 평균:</strong> 정의된 가중치를 적용하여 종합 BDS 계산</li>
                                <li><strong>지역별 적용:</strong> 전국 평균을 기준으로 지역별 특성 반영</li>
                                <li><strong>예측:</strong> 2025년은 경제 지표 트렌드를 기반으로 예측</li>
                            </ol>
                            
                            <h6><i class="fas fa-exclamation-triangle me-2 text-warning"></i>주의사항</h6>
                            <ul>
                                <li>2025년 데이터는 예측치로, 실제 경제 상황과 다를 수 있습니다.</li>
                                <li>지역별 특성은 전국 평균 대비 상대적 차이로 계산됩니다.</li>
                                <li>가중치는 경제 전문가 의견과 문헌 조사를 기반으로 설정되었습니다.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Correlation Modal -->
    <div class="modal fade" id="correlation-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-scatter me-2"></i>
                        NAVIS vs 새로운 BDS 상관관계 설명
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>상관관계 분석이란?</h6>
                    <p>기존 NAVIS BDS와 새로운 ECOS/KOSIS 기반 BDS 간의 상관관계를 분석한 것입니다.</p>
                    
                    <h6>분석 방법:</h6>
                    <ul>
                        <li><strong>피어슨 상관계수:</strong> -1에서 1 사이의 값으로 상관관계 강도 측정</li>
                        <li><strong>1에 가까울수록:</strong> 강한 양의 상관관계 (함께 증가/감소)</li>
                        <li><strong>-1에 가까울수록:</strong> 강한 음의 상관관계 (반대 방향 변화)</li>
                        <li><strong>0에 가까울수록:</strong> 상관관계 없음</li>
                    </ul>
                    
                    <h6>해석 기준:</h6>
                    <ul>
                        <li><strong>0.7 이상:</strong> 강한 양의 상관관계</li>
                        <li><strong>0.3-0.7:</strong> 중간 정도의 양의 상관관계</li>
                        <li><strong>0.1-0.3:</strong> 약한 양의 상관관계</li>
                        <li><strong>-0.1-0.1:</strong> 상관관계 없음</li>
                        <li><strong>-0.3--0.1:</strong> 약한 음의 상관관계</li>
                        <li><strong>-0.7--0.3:</strong> 중간 정도의 음의 상관관계</li>
                        <li><strong>-1--0.7:</strong> 강한 음의 상관관계</li>
                    </ul>
                    
                    <h6>정책적 시사점:</h6>
                    <ul>
                        <li><strong>높은 상관관계:</strong> 두 지표가 유사한 패턴을 보임, 상호 검증 가능</li>
                        <li><strong>낮은 상관관계:</strong> 서로 다른 측면을 측정하므로 보완적 활용</li>
                        <li><strong>지역별 차이:</strong> 지역 특성에 따른 상관관계 차이 분석</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 균형발전 지수 설명 모달 -->
    <div class="modal fade" id="balance-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">지역균형발전 지수 상세 설명</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>지역균형발전 지수란?</h6>
                    <p>전국 17개 지역의 BDS 값 분포를 분석하여 지역 간 균형발전 정도를 100점 만점으로 평가하는 지수입니다.</p>
                    
                    <h6>계산 방법</h6>
                    <p>다음 네 가지 요소를 종합하여 계산됩니다:</p>
                    <ul>
                        <li><strong>최고-최저 격차 점수 (25%):</strong> 최고 BDS와 최저 BDS의 차이 (격차당 50점 감점)</li>
                        <li><strong>상위/하위 평균 차이 점수 (25%):</strong> 상위 30%와 하위 30% 지역의 평균 차이 (차이당 60점 감점)</li>
                        <li><strong>분산도 점수 (30%):</strong> 전체 지역의 표준편차 (표준편차당 40점 감점)</li>
                        <li><strong>중간값 차이 점수 (20%):</strong> 상위 30%와 하위 30%의 중간값 차이 (차이당 50점 감점)</li>
                    </ul>
                    
                    <h6>발전 수준 판정 기준</h6>
                    <ul>
                        <li><strong>90점 이상 - 매우 균형:</strong> 지역 간 격차가 매우 작고 균형발전이 잘 이루어진 상태</li>
                        <li><strong>75-89점 - 균형:</strong> 지역 간 격차가 적당하고 비교적 균형적인 발전 상태</li>
                        <li><strong>60-74점 - 보통:</strong> 지역 간 격차가 있지만 관리 가능한 수준</li>
                        <li><strong>60점 미만 - 불균형:</strong> 지역 간 격차가 크고 균형발전이 필요한 상태</li>
                    </ul>
                    
                    <h6>해석의 의미</h6>
                    <p>이 지수는 상대평가 방식으로, 필연적으로 일부 지역은 낮은 평가를 받게 됩니다. 하지만 점수가 높을수록 전국적으로 더 균형적인 발전이 이루어지고 있음을 의미합니다.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 지역별 BDS 지도 설명 모달 -->
    <div class="modal fade" id="map-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">지역별 BDS 지도 상세 설명</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>지역별 BDS 지도란?</h6>
                    <p>전국 17개 지역의 BDS 값을 지도상에 시각화하여 지역별 경제적 활력과 비즈니스 환경을 한눈에 파악할 수 있는 지도입니다.</p>
                    
                    <h6>색상 구분</h6>
                    <ul>
                        <li><strong>연한 파란색 (상위 30%):</strong> 높은 BDS - 경제적 활력이 높고 비즈니스 환경이 우수한 지역</li>
                        <li><strong>연한 노란색 (중간 30-70%):</strong> 보통 BDS - 안정적인 경제 환경을 갖춘 지역</li>
                        <li><strong>연한 빨간색 (하위 30%):</strong> 낮은 BDS - 경제적 개선이 필요한 지역</li>
                    </ul>
                    
                    <h6>기능</h6>
                    <ul>
                        <li><strong>연도별 조회:</strong> 1997년부터 2025년까지 연도별 BDS 값 확인 가능</li>
                        <li><strong>호버 정보:</strong> 마우스를 지역에 올리면 해당 연도의 BDS 값과 GDP 정보 표시</li>
                        <li><strong>클릭 상세정보:</strong> 지역을 클릭하면 인구, 경제활동인구 등 상세 정보 표시</li>
                        <li><strong>예측 데이터:</strong> 2025년은 경제 지표 트렌드를 기반으로 한 예측치</li>
                    </ul>
                    
                    <h6>데이터 소스</h6>
                    <ul>
                        <li><strong>BDS 값:</strong> 한국은행 ECOS API + 통계청 KOSIS 데이터 기반</li>
                        <li><strong>GDP 데이터:</strong> 한국은행 지역경제통계</li>
                        <li><strong>인구 데이터:</strong> 통계청 KOSIS 인구통계</li>
                        <li><strong>지도 데이터:</strong> GeoJSON 기반 한국 행정구역 경계</li>
                    </ul>
                    
                    <h6>해석 방법</h6>
                    <p>색상이 파란색에 가까울수록 해당 지역의 경제적 활력이 높음을 의미하며, 빨간색에 가까울수록 경제적 개선이 필요함을 나타냅니다. 연도별 변화를 통해 지역 발전 추이를 파악할 수 있습니다.</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
