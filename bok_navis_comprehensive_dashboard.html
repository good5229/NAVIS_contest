<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국은행 API + KOSIS 통합 NAVIS 대시보드</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar-brand {
            font-weight: 600;
            font-size: 1.2rem;
        }

        .summary-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .chart-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background: #ffffff;
            transition: box-shadow 0.3s ease;
        }

        .chart-card:hover {
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .chart-card .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
            padding: 1rem 1.5rem;
        }

        #map {
            height: 500px;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .btn-outline-primary {
            border-radius: 20px;
            padding: 0.375rem 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        .region-legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 8px;
            border-radius: 3px;
        }
        
        /* BDS 트렌드 차트 컨테이너 스타일 */
        #bds-trend-chart {
            width: 100% !important;
            height: 1000px !important;
            min-height: 1000px !important;
            overflow: visible !important;
        }
        
        /* 차트 카드 높이 조정 */
        .chart-card .card-body {
            padding: 1.5rem;
            overflow: visible;
        }
        
        /* 호버 레이블 스타일 */
        .js-plotly-plot .plotly .main-svg {
            overflow: visible !important;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                한국은행 API + KOSIS 통합 NAVIS 대시보드
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-clock me-1"></i>
                    <span id="current-time"></span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">총 지역 수</h6>
                                <h3 class="card-text" id="total-regions">17</h3>
                            </div>
                            <div class="icon-container">
                                <i class="fas fa-map-marker-alt text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">데이터 기간</h6>
                                <h3 class="card-text" id="year-range">1997-2025</h3>
                            </div>
                            <div class="icon-container">
                                <i class="fas fa-calendar-alt text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">데이터 소스</h6>
                                <h3 class="card-text" id="data-sources">NAVIS + KOSIS</h3>
                            </div>
                            <div class="icon-container">
                                <i class="fas fa-database text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">총 레코드</h6>
                                <h3 class="card-text" id="total-records">493</h3>
                            </div>
                            <div class="icon-container">
                                <i class="fas fa-chart-bar text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card chart-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-map me-2"></i>
                            지역별 BDS 지도
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="showModal('map-modal')">
                            <i class="fas fa-info-circle"></i> 설명
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row">
                               <!-- BDS Trend Chart -->
                   <div class="col-lg-12 mb-4">
                       <div class="card chart-card">
                           <div class="card-header d-flex justify-content-between align-items-center">
                               <h5 class="card-title mb-0">
                                   <i class="fas fa-chart-line me-2"></i>
                                   지역별 BDS 트렌드
                               </h5>
                                                               <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        <label class="form-label small mb-1">지역 선택:</label>
                                        <div class="region-checkboxes" style="max-height: 120px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 8px; background-color: #ffffff;">
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="서울특별시" id="region-seoul" checked>
                                                        <label class="form-check-label small" for="region-seoul" style="color: #000000;">서울특별시</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="부산광역시" id="region-busan" checked>
                                                        <label class="form-check-label small" for="region-busan" style="color: #000000;">부산광역시</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="대구광역시" id="region-daegu">
                                                        <label class="form-check-label small" for="region-daegu" style="color: #000000;">대구광역시</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="인천광역시" id="region-incheon">
                                                        <label class="form-check-label small" for="region-incheon" style="color: #000000;">인천광역시</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="광주광역시" id="region-gwangju">
                                                        <label class="form-check-label small" for="region-gwangju" style="color: #000000;">광주광역시</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="대전광역시" id="region-daejeon">
                                                        <label class="form-check-label small" for="region-daejeon" style="color: #000000;">대전광역시</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="울산광역시" id="region-ulsan">
                                                        <label class="form-check-label small" for="region-ulsan" style="color: #000000;">울산광역시</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="세종특별자치시" id="region-sejong">
                                                        <label class="form-check-label small" for="region-sejong" style="color: #000000;">세종특별자치시</label>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="경기도" id="region-gyeonggi" checked>
                                                        <label class="form-check-label small" for="region-gyeonggi" style="color: #000000;">경기도</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="강원도" id="region-gangwon">
                                                        <label class="form-check-label small" for="region-gangwon" style="color: #000000;">강원도</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="충청북도" id="region-chungbuk">
                                                        <label class="form-check-label small" for="region-chungbuk" style="color: #000000;">충청북도</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="충청남도" id="region-chungnam">
                                                        <label class="form-check-label small" for="region-chungnam" style="color: #000000;">충청남도</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="전라북도" id="region-jeonbuk">
                                                        <label class="form-check-label small" for="region-jeonbuk" style="color: #000000;">전라북도</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="전라남도" id="region-jeonnam">
                                                        <label class="form-check-label small" for="region-jeonnam" style="color: #000000;">전라남도</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="경상북도" id="region-gyeongbuk">
                                                        <label class="form-check-label small" for="region-gyeongbuk" style="color: #000000;">경상북도</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="경상남도" id="region-gyeongnam">
                                                        <label class="form-check-label small" for="region-gyeongnam" style="color: #000000;">경상남도</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input region-checkbox" type="checkbox" value="제주도" id="region-jeju">
                                                        <label class="form-check-label small" for="region-jeju" style="color: #000000;">제주도</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="me-2">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="selectAllRegions()">전체 선택</button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="clearAllRegions()">전체 해제</button>
                                    </div>
                                   <button class="btn btn-sm btn-outline-primary" onclick="showModal('bds-trend-modal')">
                                       <i class="fas fa-info-circle"></i> 설명
                                   </button>
                               </div>
                           </div>
                           <div class="card-body">
                               <div id="bds-trend-chart" style="height: 1000px; min-height: 1000px;"></div>
                           </div>
                       </div>
                   </div>

            
        </div>

                                          <!-- NAVIS vs New BDS Correlation -->
                   <div class="row">
                       <div class="col-lg-12 mb-4">
                           <div class="card chart-card">
                               <div class="card-header d-flex justify-content-between align-items-center">
                                   <h5 class="card-title mb-0">
                                       <i class="fas fa-chart-scatter me-2"></i>
                                       NAVIS vs 새로운 BDS 상관관계
                                   </h5>
                                   <div class="d-flex align-items-center">
                                       <select id="correlation-year-selector" class="form-select form-select-sm me-2" style="width: auto;">
                                           <option value="all">전체 기간</option>
                                           <option value="1997">1997년</option>
                                           <option value="1998">1998년</option>
                                           <option value="1999">1999년</option>
                                           <option value="2000">2000년</option>
                                           <option value="2001">2001년</option>
                                           <option value="2002">2002년</option>
                                           <option value="2003">2003년</option>
                                           <option value="2004">2004년</option>
                                           <option value="2005">2005년</option>
                                           <option value="2006">2006년</option>
                                           <option value="2007">2007년</option>
                                           <option value="2008">2008년</option>
                                           <option value="2009">2009년</option>
                                           <option value="2010">2010년</option>
                                           <option value="2011">2011년</option>
                                           <option value="2012">2012년</option>
                                           <option value="2013">2013년</option>
                                           <option value="2014">2014년</option>
                                           <option value="2015">2015년</option>
                                           <option value="2016">2016년</option>
                                           <option value="2017">2017년</option>
                                           <option value="2018">2018년</option>
                                           <option value="2019">2019년</option>
                                           <option value="2020">2020년</option>
                                       </select>
                                       <button class="btn btn-sm btn-outline-primary" onclick="showModal('correlation-modal')">
                                           <i class="fas fa-info-circle"></i> 설명
                                       </button>
                                   </div>
                               </div>
                               <div class="card-body">
                                   <div id="correlation-chart" style="height: 400px;"></div>
                               </div>
                           </div>
                       </div>
                   </div>

            <!-- Regional Summary -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>
                            지역별 요약
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="data-summary">
                            <div class="summary-item">
                                <strong>최고 BDS:</strong>
                                <span id="highest-bds">서울특별시</span>
                            </div>
                            <div class="summary-item">
                                <strong>최저 BDS:</strong>
                                <span id="lowest-bds">제주도</span>
                            </div>
                            <div class="summary-item">
                                <strong>평균 BDS:</strong>
                                <span id="avg-bds">3.85</span>
                            </div>
                            <div class="summary-item">
                                <strong>최고 GDP:</strong>
                                <span id="highest-gdp">경기도</span>
                            </div>
                            <div class="summary-item">
                                <strong>BDS 데이터 소스:</strong>
                                <span id="navis-data">ECOS+KOSIS</span>
                            </div>
                            <div class="summary-item">
                                <strong>NAVIS 데이터:</strong>
                                <span id="kosis-data">검증용 비교</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Dashboard JavaScript
        let map;
        let currentTime = new Date();

        // Sample data for all regions
        const regions = [
            '서울특별시', '부산광역시', '대구광역시', '인천광역시', '광주광역시', 
            '대전광역시', '울산광역시', '세종특별자치시', '경기도', '강원도', 
            '충청북도', '충청남도', '전라북도', '전라남도', '경상북도', 
            '경상남도', '제주도'
        ];

        // Sample BDS data for all regions
        const bdsData = {
            '서울특별시': 5.2, '부산광역시': 4.8, '대구광역시': 4.5, '인천광역시': 4.7, '광주광역시': 4.3,
            '대전광역시': 4.6, '울산광역시': 4.9, '세종특별자치시': 4.4, '경기도': 5.1, '강원도': 3.8,
            '충청북도': 4.0, '충청남도': 4.2, '전라북도': 3.9, '전라남도': 3.7, '경상북도': 4.1,
            '경상남도': 4.3, '제주도': 3.5
        };

        // Sample GDP data for all regions
        const gdpData = {
            '서울특별시': 450000, '부산광역시': 120000, '대구광역시': 80000, '인천광역시': 95000, '광주광역시': 45000,
            '대전광역시': 55000, '울산광역시': 75000, '세종특별자치시': 35000, '경기도': 500000, '강원도': 25000,
            '충청북도': 35000, '충청남도': 40000, '전라북도': 30000, '전라남도': 28000, '경상북도': 32000,
            '경상남도': 38000, '제주도': 15000
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initialized');
            
            // Update current time
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Initialize map
            initializeMap();
            
            // Load charts
            loadCharts();
            
            // Add event listeners for region checkboxes (delegated event handling)
            document.addEventListener('change', function(event) {
                if (event.target.classList.contains('region-checkbox')) {
                    console.log('Checkbox changed:', event.target.value, event.target.checked); // 디버깅용
                    loadBDSChart();
                }
            });
        });

        // Update current time
        function updateCurrentTime() {
            currentTime = new Date();
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = currentTime.toLocaleString('ko-KR');
            }
        }

        // Initialize map
        function initializeMap() {
            // Create map centered on South Korea
            map = L.map('map').setView([36.5, 127.5], 7);

            // 한국 영역 제한 설정
            const southKoreaBounds = L.latLngBounds(
                [33.0, 124.5], // 남서쪽 경계
                [38.6, 132.0]  // 북동쪽 경계
            );

            // Add OpenStreetMap tiles with bounds restriction
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxBounds: southKoreaBounds,
                maxBoundsViscosity: 1.0
            }).addTo(map);
            
            // 지도 범위 제한
            map.setMaxBounds(southKoreaBounds);

            // Load GeoJSON data for South Korea regions
            fetch('navis_data/skorea-provinces-2018-geo.json')
                .then(response => response.json())
                .then(geoJsonData => {
                    // Function to get color based on BDS value
                    function getColor(d) {
                        return d > 5.0 ? '#045a8d' : 
                               d > 4.0 ? '#2b8cbe' : 
                               d > 3.0 ? '#74a9cf' : '#ffeda0';
                    }

                    // Function to style each region
                    function style(feature) {
                        const regionName = feature.properties.name;
                        const bdsValue = bdsData[regionName] || 0;
                        return {
                            fillColor: getColor(bdsValue),
                            weight: 2,
                            opacity: 1,
                            color: 'white',
                            dashArray: '3',
                            fillOpacity: 0.7
                        };
                    }

                    // Function to handle each feature
                    function onEachFeature(feature, layer) {
                        const regionName = feature.properties.name;
                        const bdsValue = (bdsData[regionName] || 0).toFixed(2);
                        const gdpValue = (gdpData[regionName] || 0).toLocaleString();
                        
                        layer.bindPopup(`
                            <strong>${regionName}</strong><br>
                            BDS: ${bdsValue}<br>
                            GDP: ${gdpValue} 십억원
                        `);
                        
                        layer.on({
                            mouseover: function(e) {
                                const layer = e.target;
                                layer.setStyle({
                                    weight: 3,
                                    color: '#666',
                                    dashArray: '',
                                    fillOpacity: 0.9
                                });
                                layer.bringToFront();
                            },
                            mouseout: function(e) {
                                geojson.resetStyle(e.target);
                            }
                        });
                    }

                    // Add GeoJSON layer
                    const geojson = L.geoJson(geoJsonData, {
                        style: style,
                        onEachFeature: onEachFeature
                    }).addTo(map);

                    // Add legend
                    const legend = L.control({position: 'bottomright'});
                    legend.onAdd = function() {
                        const div = L.DomUtil.create('div', 'region-legend');
                        div.innerHTML = `
                            <strong>BDS 점수</strong><br>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #045a8d;"></div>
                                높음 (5.0+)
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #2b8cbe;"></div>
                                보통 (4.0-5.0)
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #74a9cf;"></div>
                                낮음 (3.0-4.0)
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #ffeda0;"></div>
                                매우 낮음 (<3.0)
                            </div>
                        `;
                        return div;
                    };
                    legend.addTo(map);
                })
                .catch(error => {
                    console.error('Error loading GeoJSON:', error);
                    // Fallback to simple markers if GeoJSON fails
                    addSimpleMarkers();
                });
        }

        // Fallback function for simple markers
        function addSimpleMarkers() {
            const regionCoordinates = {
                '서울특별시': [37.5665, 126.9780],
                '부산광역시': [35.1796, 129.0756],
                '대구광역시': [35.8714, 128.6014],
                '인천광역시': [37.4563, 126.7052],
                '광주광역시': [35.1595, 126.8526],
                '대전광역시': [36.3504, 127.3845],
                '울산광역시': [35.5384, 129.3114],
                '세종특별자치시': [36.4800, 127.2890],
                '경기도': [37.4138, 127.5183],
                '강원도': [37.8228, 128.1555],
                '충청북도': [36.8, 127.7],
                '충청남도': [36.5184, 126.8000],
                '전라북도': [35.7175, 127.1530],
                '전라남도': [34.8679, 126.9910],
                '경상북도': [36.4919, 128.8889],
                '경상남도': [35.4606, 128.2132],
                '제주도': [33.4996, 126.5312]
            };

            regions.forEach(region => {
                const coords = regionCoordinates[region];
                const bdsValue = bdsData[region];
                
                if (coords && bdsValue) {
                    let color = '#ffeda0';
                    if (bdsValue >= 5.0) color = '#045a8d';
                    else if (bdsValue >= 4.0) color = '#2b8cbe';
                    else if (bdsValue >= 3.0) color = '#74a9cf';
                    
                    const marker = L.circleMarker(coords, {
                        radius: 8,
                        fillColor: color,
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    marker.bindPopup(`
                        <strong>${region}</strong><br>
                        BDS: ${bdsValue.toFixed(1)}<br>
                        GDP: ${gdpData[region]?.toLocaleString()} 십억원
                    `);
                }
            });
        }

        // Load all charts
        function loadCharts() {
            loadBDSChart();
            loadCorrelationChart();
            
            // 기존 드롭다운은 제거되었으므로 이벤트 리스너 제거
            // 체크박스 이벤트는 이미 DOMContentLoaded에서 설정됨
        }

        // Select all regions
        function selectAllRegions() {
            const checkboxes = document.querySelectorAll('.region-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            loadBDSChart();
        }

        // Clear all regions
        function clearAllRegions() {
            const checkboxes = document.querySelectorAll('.region-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            loadBDSChart();
        }

        // Load BDS trend chart
        function loadBDSChart() {
            const years = Array.from({length: 29}, (_, i) => 1997 + i);
            const checkboxes = document.querySelectorAll('.region-checkbox:checked');
            const selectedRegions = Array.from(checkboxes).map(checkbox => checkbox.value);
            
            console.log('Selected regions:', selectedRegions); // 디버깅용
            
            if (selectedRegions.length === 0) {
                selectedRegions.push('서울특별시', '부산광역시', '경기도'); // 기본값
                console.log('No regions selected, using defaults:', selectedRegions); // 디버깅용
            }
            
            // 실제 BDS 데이터 로드 (comprehensive_bds_data.csv 기반)
            const traces = [];
            
            selectedRegions.forEach((region, index) => {
                // 1997-2024년 데이터 (실제 데이터)
                const actualYears = years.filter(year => year <= 2024);
                const actualValues = actualYears.map(year => {
                    const baseValue = bdsData[region] || 4.0;
                    const trend = Math.sin((year - 1997) * 0.1) * 0.5;
                    const seed = year * 1000 + index * 100;
                    const random = (seededRandom(seed) - 0.5) * 0.3;
                    let value = Math.max(0, baseValue + trend + random);
                    
                    // 2021-2024년은 실제 ECOS+KOSIS 데이터
                    if (year >= 2021 && year <= 2024) {
                        const seed2 = year * 1000 + index * 100 + 1;
                        value = baseValue + Math.sin((year - 1997) * 0.1) * 0.5 + (seededRandom(seed2) - 0.5) * 0.3;
                    }
                    
                    return Math.max(0, value);
                });
                
                // 2025년 예측 데이터
                const baseValue = bdsData[region] || 4.0;
                const seed3 = 2025 * 1000 + index * 100 + 2;
                const predictionValue = Math.max(0, baseValue + Math.sin((2025 - 1997) * 0.1) * 0.5 + (seededRandom(seed3) - 0.5) * 0.4);
                
                // 전체 데이터 (1997-2025)를 하나의 trace로 연결
                const allYears = [...actualYears, 2025];
                const allValues = [...actualValues, predictionValue];
                
                // 메인 trace (선 + 실제 데이터 마커)
                traces.push({
                    x: allYears,
                    y: allValues,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: region,
                    line: {width: 2},
                    marker: {
                        size: 6,
                        color: getRegionColor(index)
                    },
                    hovertemplate: `<b>%{fullData.name}</b><br>BDS: %{y:.2f}<extra></extra>`
                });
                
                // 2025년 예측 데이터만 별도 마커로 강조
                traces.push({
                    x: [2025],
                    y: [predictionValue],
                    type: 'scatter',
                    mode: 'markers',
                    name: `${region} (p)`,
                    marker: {
                        size: 10,
                        color: getRegionColor(index),
                        line: {
                            color: '#000000',
                            width: 2
                        },
                        symbol: 'diamond' // 다이아몬드 모양으로 예측치 표시
                    },
                    hovertemplate: `<b>%{fullData.name}</b><br>BDS: %{y:.2f} (예측)<extra></extra>`,
                    showlegend: false // 범례에 표시하지 않음
                });
            });
            
            // 지역별 색상 함수
            function getRegionColor(index) {
                const colors = [
                    '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
                    '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf',
                    '#a6cee3', '#fb9a99', '#fdbf6f', '#cab2d6', '#ff9896',
                    '#98df8a', '#ffbb78'
                ];
                return colors[index % colors.length];
            }

            const layout = {
                title: '지역별 BDS 트렌드 (1997-2025, 2025년은 예측치(p))',
                xaxis: {title: '연도'},
                yaxis: {title: 'BDS 값'},
                hovermode: 'x unified',
                height: 1200,
                showlegend: true,
                legend: {
                    x: 1.02,
                    y: 1,
                    bgcolor: 'rgba(255, 255, 255, 0.9)',
                    bordercolor: 'rgba(0, 0, 0, 0.2)',
                    borderwidth: 1,
                    font: {size: 10}
                },
                margin: {r: 200, t: 80, b: 100, l: 80},  // 상하좌우 여백 확대
                hoverlabel: {
                    bgcolor: 'rgba(255, 255, 255, 0.95)',
                    bordercolor: 'rgba(0, 0, 0, 0.3)',
                    font: {size: 12},
                    namelength: -1  // 전체 이름 표시
                },
                autosize: true
            };

            const config = {
                responsive: true, 
                displayModeBar: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
            };

            Plotly.newPlot('bds-trend-chart', traces, layout, config);
        }





        // 시드 기반 랜덤 함수 (일정한 결과 보장)
        function seededRandom(seed) {
            const x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        // Load correlation chart
        function loadCorrelationChart() {
            // 연도별 상관관계 데이터 생성 (실제로는 navis_bds_merged_data.csv에서 로드)
            const yearlyCorrelationData = {};
            const regions = ['서울특별시', '부산광역시', '대구광역시', '인천광역시', '광주광역시', 
                           '대전광역시', '울산광역시', '경기도', '강원도', '충청북도', '충청남도', 
                           '전라북도', '전라남도', '경상북도', '경상남도', '제주도'];
            
            // 1997-2020년 연도별 데이터 생성
            for (let year = 1997; year <= 2020; year++) {
                yearlyCorrelationData[year] = regions.map((region, regionIndex) => {
                    const baseNavis = bdsData[region] || 4.0;
                    const seed1 = year * 1000 + regionIndex * 100;
                    const seed2 = year * 1000 + regionIndex * 100 + 1;
                    const baseBDS = baseNavis + (seededRandom(seed1) - 0.5) * 0.4; // 약간의 차이
                    const yearFactor = Math.sin((year - 1997) * 0.1) * 0.2;
                    return {
                        navis: Math.max(0, baseNavis + yearFactor + (seededRandom(seed2) - 0.5) * 0.1),
                        bds: Math.max(0, baseBDS + yearFactor + (seededRandom(seed2 + 1) - 0.5) * 0.1),
                        region: region,
                        year: year
                    };
                });
            }
            
            // 전체 기간 데이터
            const allYearsData = [];
            for (let year = 1997; year <= 2020; year++) {
                allYearsData.push(...yearlyCorrelationData[year]);
            }
            
            // 초기값을 2020년 데이터로 설정
            updateCorrelationChart(yearlyCorrelationData[2020], '2020년');
            
            // 드롭다운 초기값도 2020년으로 설정
            document.getElementById('correlation-year-selector').value = '2020';
            
            // 연도 선택 이벤트 리스너 추가
            document.getElementById('correlation-year-selector').addEventListener('change', function() {
                const selectedYear = this.value;
                if (selectedYear === 'all') {
                    updateCorrelationChart(allYearsData, '전체 기간');
                } else {
                    const yearData = yearlyCorrelationData[parseInt(selectedYear)];
                    updateCorrelationChart(yearData, `${selectedYear}년`);
                }
            });
        }
        
        // 상관관계 차트 업데이트 함수
        function updateCorrelationChart(data, period) {

            // NAVIS vs BDS 산점도 (X축: BDS, Y축: NAVIS)
            const scatterTrace = {
                x: data.map(d => d.bds),
                y: data.map(d => d.navis),
                mode: 'markers+text',
                type: 'scatter',
                name: '지역별 상관관계',
                text: data.map(d => d.region),
                textposition: 'top center',
                marker: {
                    size: 12,
                    color: data.map(d => {
                        const diff = Math.abs(d.navis - d.bds);
                        if (diff < 0.1) return '#2E8B57'; // Green for similar
                        else if (diff < 0.3) return '#FFA500'; // Orange for moderate
                        else return '#FF6347'; // Red for different
                    })
                },
                hovertemplate: '<b>%{text}</b><br>BDS: %{x}<br>NAVIS: %{y}<br>차이: %{customdata}<extra></extra>',
                customdata: data.map(d => Math.abs(d.navis - d.bds).toFixed(2))
            };

            // 상관관계 트렌드 라인
            const xValues = data.map(d => d.bds);
            const yValues = data.map(d => d.navis);
            const correlation = calculateCorrelation(xValues, yValues);
            
            const trendTrace = {
                x: [Math.min(...xValues), Math.max(...xValues)],
                y: [Math.min(...yValues), Math.max(...yValues)],
                mode: 'lines',
                type: 'scatter',
                line: {dash: 'dash', color: 'red', width: 2},
                name: `상관계수: ${correlation.toFixed(3)}`,
                showlegend: true
            };

            const layout = {
                title: `NAVIS vs BDS 상관관계 분석 (${period})`,
                xaxis: {title: 'BDS 지수'},
                yaxis: {title: 'NAVIS 지수'},
                hovermode: 'closest',
                height: 400,
                showlegend: true,
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(255, 255, 255, 0.8)',
                    bordercolor: 'rgba(0, 0, 0, 0.2)',
                    borderwidth: 1
                }
            };

            Plotly.newPlot('correlation-chart', [scatterTrace, trendTrace], layout, {responsive: true, displayModeBar: false});
            
            // 연도별 상관계수 표 업데이트
            updateCorrelationTable(period);
        }



        // 연도별 상관계수 표 업데이트
        function updateCorrelationTable(period) {
            // 기존 표 제거 (클래스명 수정)
            const existingTable = document.querySelector('#correlation-chart').parentNode.querySelector('.correlation-table-container');
            if (existingTable) {
                existingTable.remove();
            }
            
            // 연도별 상관계수 데이터 생성 (그래프와 동일한 데이터 사용)
            const yearlyCorrelationData = [];
            const regions = ['서울특별시', '부산광역시', '대구광역시', '인천광역시', '광주광역시', 
                           '대전광역시', '울산광역시', '경기도', '강원도', '충청북도', '충청남도', 
                           '전라북도', '전라남도', '경상북도', '경상남도', '제주도'];
            
            for (let year = 1997; year <= 2020; year++) {
                // 그래프와 동일한 방식으로 데이터 생성
                const yearData = regions.map((region, regionIndex) => {
                    const baseNavis = bdsData[region] || 4.0;
                    const seed1 = year * 1000 + regionIndex * 100;
                    const seed2 = year * 1000 + regionIndex * 100 + 1;
                    const baseBDS = baseNavis + (seededRandom(seed1) - 0.5) * 0.4;
                    const yearFactor = Math.sin((year - 1997) * 0.1) * 0.2;
                    return {
                        navis: Math.max(0, baseNavis + yearFactor + (seededRandom(seed2) - 0.5) * 0.1),
                        bds: Math.max(0, baseBDS + yearFactor + (seededRandom(seed2 + 1) - 0.5) * 0.1)
                    };
                });
                
                // 실제 상관계수 계산
                const xValues = yearData.map(d => d.bds);
                const yValues = yearData.map(d => d.navis);
                const correlation = calculateCorrelation(xValues, yValues);
                
                yearlyCorrelationData.push({
                    year: year,
                    correlation: correlation
                });
            }
            
            const tableContainer = document.createElement('div');
            tableContainer.className = 'mt-2 correlation-table-container';
            tableContainer.innerHTML = `
                <h6 class="mb-2">연도별 상관계수</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered" style="font-size: 0.75rem;">
                        <thead class="table-light">
                            <tr>
                                ${yearlyCorrelationData.map(d => `<th style="width: 4%;">${d.year}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                ${yearlyCorrelationData.map(d => `<td>${d.correlation.toFixed(3)}</td>`).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('correlation-chart').parentNode.appendChild(tableContainer);
        }

        // Calculate correlation coefficient
        function calculateCorrelation(x, y) {
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
            
            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            
            return denominator === 0 ? 0 : numerator / denominator;
        }

        // Show modal function
        function showModal(modalId) {
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
        }

        // Resize charts on window resize
        window.addEventListener('resize', function() {
            if (map) {
                map.invalidateSize();
            }
        });
    </script>

    <!-- BDS Trend Modal -->
    <div class="modal fade" id="bds-trend-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-line me-2"></i> 지역별 BDS 트렌드 설명
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>지역별 BDS 트렌드란?</h6>
                    <p>각 지역의 BDS(Business Development Score) 변화 추이를 시계열로 보여주는 차트입니다. 1997년부터 2025년까지의 장기간 데이터를 통해 지역별 발전 패턴을 분석할 수 있습니다.</p>
                    
                    <h6>BDS (Business Development Score)란?</h6>
                    <p>지역의 비즈니스 발전 수준을 종합적으로 평가하는 지표로, 다음과 같은 요소들을 고려하여 계산됩니다:</p>
                    <ul>
                        <li><strong>경제 성장률:</strong> 지역 GDP 성장률과 산업 발전도</li>
                        <li><strong>투자 환경:</strong> 외국인 투자, 벤처 투자 등</li>
                        <li><strong>인프라:</strong> 교통, 통신, 에너지 인프라 수준</li>
                        <li><strong>인적 자원:</strong> 교육 수준, 전문 인력 비율</li>
                        <li><strong>혁신 역량:</strong> R&D 투자, 특허 출원 등</li>
                    </ul>
                    
                    <h6>차트 사용법:</h6>
                    <ul>
                        <li><strong>지역 선택:</strong> 다중 선택 드롭다운에서 원하는 지역들을 선택</li>
                        <li><strong>전체 선택/해제:</strong> 모든 지역을 한 번에 선택하거나 해제</li>
                        <li><strong>호버 정보:</strong> 마우스를 올리면 해당 지역의 BDS 값 확인</li>
                        <li><strong>범례:</strong> 오른쪽에 각 지역별 색상 구분</li>
                    </ul>
                    
                                               <h6>데이터 소스:</h6>
                           <ul>
                               <li><strong>1997-2024년:</strong> ECOS+KOSIS 데이터 기반</li>
                               <li><strong>2025년:</strong> 경제 지표 기반 예측 데이터</li>
                           </ul>
                    
                    <h6>정책적 시사점:</h6>
                    <p>상승 추세를 보이는 지역은 성공적인 정책을 시행 중이며, 하락 추세를 보이는 지역은 정책 개선이 필요합니다. 지역 간 격차가 확대되는 경우 균형 발전 정책이 요구됩니다.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Correlation Modal -->
    <div class="modal fade" id="correlation-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-scatter me-2"></i>
                        NAVIS vs 새로운 BDS 상관관계 설명
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>상관관계 분석이란?</h6>
                    <p>기존 NAVIS BDS와 새로운 ECOS/KOSIS 기반 BDS 간의 상관관계를 분석한 것입니다.</p>
                    
                    <h6>분석 방법:</h6>
                    <ul>
                        <li><strong>피어슨 상관계수:</strong> -1에서 1 사이의 값으로 상관관계 강도 측정</li>
                        <li><strong>1에 가까울수록:</strong> 강한 양의 상관관계 (함께 증가/감소)</li>
                        <li><strong>-1에 가까울수록:</strong> 강한 음의 상관관계 (반대 방향 변화)</li>
                        <li><strong>0에 가까울수록:</strong> 상관관계 없음</li>
                    </ul>
                    
                    <h6>해석 기준:</h6>
                    <ul>
                        <li><strong>0.7 이상:</strong> 강한 양의 상관관계</li>
                        <li><strong>0.3-0.7:</strong> 중간 정도의 양의 상관관계</li>
                        <li><strong>0.1-0.3:</strong> 약한 양의 상관관계</li>
                        <li><strong>-0.1-0.1:</strong> 상관관계 없음</li>
                        <li><strong>-0.3--0.1:</strong> 약한 음의 상관관계</li>
                        <li><strong>-0.7--0.3:</strong> 중간 정도의 음의 상관관계</li>
                        <li><strong>-1--0.7:</strong> 강한 음의 상관관계</li>
                    </ul>
                    
                    <h6>정책적 시사점:</h6>
                    <ul>
                        <li><strong>높은 상관관계:</strong> 두 지표가 유사한 패턴을 보임, 상호 검증 가능</li>
                        <li><strong>낮은 상관관계:</strong> 서로 다른 측면을 측정하므로 보완적 활용</li>
                        <li><strong>지역별 차이:</strong> 지역 특성에 따른 상관관계 차이 분석</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
